
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://courses.mlops.vn/mlops-crash-course/monitoring/monitoring-service/" rel="canonical"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.3.1, mkdocs-material-8.4.1" name="generator"/>
<title>Monitoring service - MLOpsVN Courses</title>
<link href="../../../assets/stylesheets/main.69437709.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.cbb835fc.min.css" rel="stylesheet"/>
<meta content="#4cae4f" name="theme-color"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../assets/stylesheets/styles.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>html.glightbox-open { overflow: initial; height: 100%; }</style><script src="../../../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="green" data-md-color-primary="green" data-md-color-scheme="" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#gioi-thieu">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="MLOpsVN Courses" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="MLOpsVN Courses">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            MLOpsVN Courses
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Monitoring service
            
          </span>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="MLOpsVN Courses" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="MLOpsVN Courses">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    MLOpsVN Courses
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
        Home
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../">MLOps Crash Course</a>
<label for="__nav_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="MLOps Crash Course" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          MLOps Crash Course
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" id="__nav_2_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_1">
          Tổng quan hệ thống
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Tổng quan hệ thống" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_1">
<span class="md-nav__icon md-icon"></span>
          Tổng quan hệ thống
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../tong-quan-he-thong/tong-quan-mlops/">
        Tổng quan MLOps
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tong-quan-he-thong/phan-tich-van-de/">
        Phân tích vấn đề
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tong-quan-he-thong/mlops-platform/">
        MLOps platform
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" id="__nav_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_2">
          POC
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="POC" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
          POC
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../poc/dinh-nghia-poc/">
        Định nghĩa POC
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../poc/xay-dung-poc/">
        Xây dựng POC
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" id="__nav_2_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3">
          Data pipeline
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Data pipeline" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
          Data pipeline
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../data-pipeline/tong-quan-data-pipeline/">
        Tổng quan pipeline
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../data-pipeline/airflow-co-ban/">
        Airflow cơ bản
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../data-pipeline/feature-store/">
        Feature store
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../data-pipeline/xay-dung-data-pipeline/">
        Xây dựng pipeline
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" id="__nav_2_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_4">
          Training pipeline
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Training pipeline" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
          Training pipeline
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../training-pipeline/xay-dung-training-pipeline/">
        Xây dựng training pipeline
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" id="__nav_2_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_5">
          Model serving
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Model serving" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_5">
<span class="md-nav__icon md-icon"></span>
          Model serving
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-serving/trien-khai-model-serving/">
        Triển khai model serving
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" id="__nav_2_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_6">
          Monitoring
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Monitoring" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_6">
<span class="md-nav__icon md-icon"></span>
          Monitoring
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../tong-quan-monitoring/">
        Tổng quan monitoring
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../metrics-he-thong/">
        Metrics hệ thống
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Monitoring service
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Monitoring service
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#gioi-thieu">
    Giới thiệu
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#moi-truong-phat-trien">
    Môi trường phát triển
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#thiet-ke">
    Thiết kế
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cach-test">
    Cách test
  </a>
<nav aria-label="Cách test" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#phat-hien-data-drift">
    Phát hiện data drift
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#theo-doi-model-performance">
    Theo dõi model performance
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tao-datasets">
    Tạo datasets
  </a>
<nav aria-label="Tạo datasets" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#test-datasets">
    Test datasets
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#monitoring-service">
    Monitoring service
  </a>
<nav aria-label="Monitoring service" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#monitoring-api">
    Monitoring API
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tich-hop-online-serving">
    Tích hợp Online serving
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#grafana-dashboards-va-alerts">
    Grafana dashboards và Alerts
  </a>
<nav aria-label="Grafana dashboards và Alerts" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-drift-dashboard">
    Data Drift Dashboard
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#model-performance-dashboard">
    Model Performance Dashboard
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#alerts">
    Alerts
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#thu-nghiem">
    Thử nghiệm
  </a>
<nav aria-label="Thử nghiệm" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-bi-drift">
    Data bị drift
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-khong-bi-drift">
    Data không bị drift
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tong-ket">
    Tổng kết
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7" id="__nav_2_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_7">
          CI/CD
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="CI/CD" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_7">
<span class="md-nav__icon md-icon"></span>
          CI/CD
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../ci-cd/gioi-thieu/">
        Giới thiệu
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ci-cd/kiem-thu-he-thong/">
        Kiểm thử hệ thống
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ci-cd/jenkins-co-ban/">
        Jenkins cơ bản
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ci-cd/pipeline/">
        CI/CD cho pipeline
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ci-cd/model-serving/">
        CI/CD cho serving API
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_8" id="__nav_2_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_8">
          Tổng kết
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Tổng kết" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_8">
<span class="md-nav__icon md-icon"></span>
          Tổng kết
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../tong-ket/tom-tat-noi-dung.md">
        Tóm tắt nội dung
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tong-ket/mot-so-van-de-khac.md">
        Một số vấn đề khác
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../CONTRIBUTING/">
        Contributing
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../CODE_OF_CONDUCT/">
        Code of Conduct
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#gioi-thieu">
    Giới thiệu
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#moi-truong-phat-trien">
    Môi trường phát triển
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#thiet-ke">
    Thiết kế
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cach-test">
    Cách test
  </a>
<nav aria-label="Cách test" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#phat-hien-data-drift">
    Phát hiện data drift
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#theo-doi-model-performance">
    Theo dõi model performance
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tao-datasets">
    Tạo datasets
  </a>
<nav aria-label="Tạo datasets" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#test-datasets">
    Test datasets
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#monitoring-service">
    Monitoring service
  </a>
<nav aria-label="Monitoring service" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#monitoring-api">
    Monitoring API
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tich-hop-online-serving">
    Tích hợp Online serving
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#grafana-dashboards-va-alerts">
    Grafana dashboards và Alerts
  </a>
<nav aria-label="Grafana dashboards và Alerts" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-drift-dashboard">
    Data Drift Dashboard
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#model-performance-dashboard">
    Model Performance Dashboard
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#alerts">
    Alerts
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#thu-nghiem">
    Thử nghiệm
  </a>
<nav aria-label="Thử nghiệm" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-bi-drift">
    Data bị drift
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-khong-bi-drift">
    Data không bị drift
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tong-ket">
    Tổng kết
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1>Monitoring service</h1>
<figure>
<a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/monitoring-banner.jpg"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/monitoring-banner.jpg"/></a>
<figcaption>Photo by <a href="https://unsplash.com/@ibrahimboran?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Ibrahim Boran</a> on <a href="https://unsplash.com/s/photos/monitoring?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></figcaption>
</figure>
<h2 id="gioi-thieu">Giới thiệu</h2>
<p>Trong bài trước, chúng ta đã triển khai ELK Stack để thu thập, theo dõi logs từ các services; và Prometheus server, Grafana server để theo dõi các metrics hệ thống của các services như là CPU, memory, network, v.v. Ngoài các metrics đó ra, trong một hệ thống ML, chúng ta cũng cần theo dõi các metrics liên quan tới data và model, để kịp thời phát hiện sự thay đổi của data và model performance ở production, để có thể cập nhật data hay train lại model kịp thời. Trong bài này, chúng ta sẽ thực hiện các công việc sau:</p>
<ol>
<li>Sinh ra dataset chứa feature bị drift</li>
<li>Triển khai <em>monitoring service</em> để theo dõi data và model performance</li>
<li>Thiết lập các Grafana dashboards để hiển thị các metrics về data và model</li>
</ol>
<h2 id="moi-truong-phat-trien">Môi trường phát triển</h2>
<p>Các library bạn cần cài đặt cho môi trường phát triển được đặt tại <code>monitoring_service/dev_requirements.txt</code>. Sau khi cài đặt môi trường phát triển, bạn cần làm tiếp các việc sau.</p>
<ol>
<li>
<p>Copy file <code>monitoring_service/deployment/.env-example</code>, đổi tên thành <code>monitoring_service/deployment/.env</code>. File này chứa các config cần thiết cho việc triển khai việc triển khai model serving.</p>
</li>
<li>
<p>Set env var <code>MONITORING_SERVICE_DIR</code> bằng đường dẫn tuyệt đối tới folder <code>monitoring_service</code>. Env var này là để hỗ trợ việc chạy python code trong folder <code>monitoring_service/src</code> trong quá trình phát triển.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">export</span> <span class="nv">MONITORING_SERVICE_DIR</span><span class="o">=</span><span class="s2">"path/to/mlops-crash-course-code/monitoring_service"</span>
</code></pre></div>
</li>
</ol>
<p>Các tools sẽ được sử dụng trong bài này bao gồm:</p>
<ol>
<li>Feast để truy xuất Feature Store</li>
<li>Flask để viết API cho monitoring service</li>
<li>Evidently để kiểm tra chất lượng data và model performance</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Trong quá trình chạy code cho tất cả các phần dưới đây, giả sử rằng folder gốc nơi chúng ta làm việc là folder <code>monitoring_service</code>.</p>
</div>
<h2 id="thiet-ke">Thiết kế</h2>
<p>Theo dõi các metrics liên quan tới chất lượng data và model performance là quá trình kiểm tra xem data và model performance thay đổi như thế nào theo thời gian. Đây cũng chính là yêu cầu đầu ra của monitoring service. Các chức năng chính của monitoring service được thể hiện như hình dưới</p>
<pre class="mermaid"><code>    graph LR
        n00[ ]--Training data--&gt;n1[Phát hiện&lt;br&gt;data drift]--Data metrics--&gt;n01[ ]
        n02[ ]--Production data--&gt;n1

        n10[ ]--Prediction--&gt;n2[Theo dõi model&lt;br&gt;performance]--Model performance--&gt;n11[ ]
        n12[ ]--Label--&gt;n2

        style n00 height:0px;
        style n01 height:0px;
        style n02 height:0px;
        style n10 height:0px;
        style n11 height:0px;
        style n12 height:0px;</code></pre>
<p>Thông thường, để biết được data thay đổi như thế nào, chúng ta sẽ so sánh training data với production data dựa trên một thuật toán so sánh nào đó, cho phép chúng ta biết được data có bị drift hay không, hay nói cách khác, xem các thuộc tính về thống kê của data bị thay đổi nhiều hay ít như thế nào. Như vậy, đầu vào của chức năng <strong>Phát hiện data drift</strong> là features ở bước training và features ở production.</p>
<p>Để biết được model performance thay đổi thế nào, chúng ta sẽ thu thập label ở production, so sánh với prediction mà model sinh ra, và theo dõi model performance metrics theo thời gian. Model performance ở production cũng có thể được so sánh với model performance ở bước training. Tuy nhiên, để đơn giản, chúng ta sẽ chỉ theo dõi model performance ở production. Như vậy, đầu vào của chức năng <strong>Theo dõi model performance</strong> là dự đoán của model và label ở production.</p>
<p>Trong bài này, chúng ta sẽ sử dụng thư viện Evidently để phát hiện data drift và model performance. Evidently là một thư viện open-source được sử dụng để đánh giá, kiểm tra, và giám sát data và model performance. Evidently đã tích hợp sẵn các thuật toán để theo dõi các thuộc tính thống kê của data như <strong>PSI</strong>, <strong>K-L divergence</strong>, <strong>Jensen-Shannon distance</strong>, <strong>Wasserstein distance</strong>, và các metrics phổ biến của model performance như <strong>Accuracy</strong>, <strong>F1 score</strong>, <strong>RMSE</strong>, <strong>MAE</strong>, v.v. Các bạn có thể đọc thêm ở <a href="https://docs.evidentlyai.com/reference/data-drift-algorithm">document của Evidently</a> để tìm hiểu về cách mà Evidently lựa chọn thuật toán tự động để phát hiện data drift tuỳ thuộc vào kích thước của dataset.</p>
<h2 id="cach-test">Cách test</h2>
<p>Trong phần này, trước khi bắt tay vào code, chúng ta sẽ cùng phân tích xem làm thế nào để test các chức năng của monitoring service.</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>Before you start anything, learn how to finish it.</p>
</div>
<h3 id="phat-hien-data-drift">Phát hiện data drift</h3>
<p>Để test chức năng phát hiện data drift của monitoring service, chúng ta cần sinh ra 2 bộ datasets như sau:</p>
<table>
<thead>
<tr>
<th>#</th>
<th>Dataset</th>
<th>Giá trị</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><code>normal_data</code></td>
<td>Trong khoảng <code>[A, B]</code></td>
</tr>
<tr>
<td>2</td>
<td><code>drift_data</code></td>
<td>Trong khoảng <code>[C, D]</code>; <code>C</code>, <code>D</code> nằm đủ xa <code>A</code>, <code>B</code> để gây ra data drift</td>
</tr>
</tbody>
</table>
<p>Chúng ta cũng cần sắp đặt 2 tình huống như bảng dưới đây.</p>
<table>
<thead>
<tr>
<th>#</th>
<th>Tình huống</th>
<th>Loại data</th>
<th>Dataset được dùng</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Production data không bị drift</td>
<td>Training data</td>
<td><code>normal_data</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td>Production data</td>
<td><code>normal_data</code></td>
</tr>
<tr>
<td>2</td>
<td>Production data bị drift</td>
<td>Training data</td>
<td><code>normal_data</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td>Production data</td>
<td><code>drift_data</code></td>
</tr>
</tbody>
</table>
<p>Ở tình huống 1, production data không bị drift, <code>normal_data</code> vừa là training data, vừa là production data, và được lưu vào Feature Store. Data được lấy ra ở Feature Store chính là training data, tức là sẽ không xảy ra data drift giữa training data và production data.</p>
<p>Ở tình huống 2, production data bị drift, <code>normal_data</code> ở trên vẫn là training data, còn <code>drift_data</code> là production data. <code>drift_data</code> được lưu vào Feature Store. Data được lấy ra ở Feature Store (<code>drift_data</code>) để dự đoán có giá trị nằm xa training data (<code>normal_data</code>), tức là sẽ xảy ra data drift giữa training data và production data.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Để phát hiện data drift, chúng ta sẽ so sánh training data với production data. Vậy chúng ta cần lấy ra bao nhiêu records trong training data và tích luỹ bao nhiêu records của production data thì mới bắt đầu thực hiện quá trình so sánh?</p>
</div>
<p>Khi training dataset quá lớn, chúng ta không thể lấy hết các records ra để so sánh được (nếu thuật toán so sánh không cho phép tính toán các metrics để so sánh trước). Thông thường, chúng ta sẽ cố gắng dùng một con số đủ nhỏ để việc theo dõi data được diễn ra liên tục và gần với thời gian thực nhất (near real-time), để phát hiện kịp thời các vấn đề về data. Đồng thời, con số này cũng phải đủ lớn, để các tính chất thống kê của data không bị quá khác biệt ở các phần của dataset. Phương pháp lựa chọn và con số cần lựa chọn cho số các records tuỳ thuộc vào nhu cầu và tần suất theo dõi production data của mỗi dự án.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Thuật ngữ <strong><em>reference window</em></strong> chỉ tập hợp các records để so sánh với production data. Thuật ngữ <strong><em>test window</em></strong> chỉ tập hợp các records để so sánh với <strong><em>reference window</em></strong></p>
</div>
<p>Để đơn giản, chúng ta sẽ sinh ra 5 records cho mỗi dataset, và chỉ tích luỹ 5 records của production data để thực hiện việc so sánh data.</p>
<p>Một lý do nữa cho con số 5 là vì ở Online serving API, features được lấy ra sẽ là features mới nhất trong dataset. Do đó, việc sinh ra nhiều records ở nhiều thời điểm là không cần thiết, chỉ cần đảm bảo rằng tồn tại ít nhất 1 record trong Feature Store cho mỗi driver id ở request gửi đến là đủ. Và vì dataset gốc chỉ chứa 5 driver ids bao gồm <code>[1001, 1002, 1003, 1004, 1005]</code>, nên chúng ta chỉ cần 5 records cho mỗi dataset.</p>
<p>Tóm lại, chúng ta cần sinh ra 2 datasets có khoảng giá trị nằm xa nhau, mỗi dataset có 5 records tương ứng với 5 driver ids. Để đơn giản hoá quá trình test, phân phối chuẩn sẽ được sử dụng cho các giá trị của features.</p>
<p>Bảng dưới đây là một ví dụ của <code>normal_data</code>.</p>
<table>
<thead>
<tr>
<th>index</th>
<th>datetime</th>
<th>driver_id</th>
<th>conv_rate</th>
<th>acc_rate</th>
<th>avg_daily_trips</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>2021-07-19 23:00:00+00:00</td>
<td>1001</td>
<td>0.186341</td>
<td>0.226879</td>
<td>107</td>
</tr>
<tr>
<td>1</td>
<td>2021-07-18 06:00:00+00:00</td>
<td>1002</td>
<td>0.071032</td>
<td>0.229490</td>
<td>250</td>
</tr>
<tr>
<td>2</td>
<td>2021-07-28 09:00:00+00:00</td>
<td>1003</td>
<td>0.050000</td>
<td>0.192864</td>
<td>103</td>
</tr>
<tr>
<td>3</td>
<td>2021-07-27 10:00:00+00:00</td>
<td>1004</td>
<td>0.184332</td>
<td>0.050000</td>
<td>49</td>
</tr>
<tr>
<td>4</td>
<td>2021-07-23 05:00:00+00:00</td>
<td>1005</td>
<td>0.250000</td>
<td>0.250000</td>
<td>246</td>
</tr>
</tbody>
</table>
<p>Bảng dưới đây là một ví dụ của <code>drift_data</code>.</p>
<table>
<thead>
<tr>
<th>index</th>
<th>datetime</th>
<th>driver_id</th>
<th>conv_rate</th>
<th>acc_rate</th>
<th>avg_daily_trips</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>2021-07-19 23:00:00+00:00</td>
<td>1001</td>
<td>0.886341</td>
<td>0.926879</td>
<td>807</td>
</tr>
<tr>
<td>1</td>
<td>2021-07-18 06:00:00+00:00</td>
<td>1002</td>
<td>0.771032</td>
<td>0.929490</td>
<td>950</td>
</tr>
<tr>
<td>2</td>
<td>2021-07-28 09:00:00+00:00</td>
<td>1003</td>
<td>0.750000</td>
<td>0.892864</td>
<td>803</td>
</tr>
<tr>
<td>3</td>
<td>2021-07-27 10:00:00+00:00</td>
<td>1004</td>
<td>0.884332</td>
<td>0.750000</td>
<td>750</td>
</tr>
<tr>
<td>4</td>
<td>2021-07-23 05:00:00+00:00</td>
<td>1005</td>
<td>0.950000</td>
<td>0.950000</td>
<td>946</td>
</tr>
</tbody>
</table>
<h3 id="theo-doi-model-performance">Theo dõi model performance</h3>
<p>Để test chức năng theo dõi model performance của monitoring service, chúng ta cần có label của mỗi request được gửi tới Online serving API, thì mới biết được prediction tạo bởi model là đúng hay sai.</p>
<p>Như chúng ta đã biết ở <a href="../../model-serving/trien-khai-model-serving/#online-serving">phần Online serving của bài Triển khai model serving</a>, request và response được gửi tới Online serving API có dạng như sau.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">// Request</span><span class="w"></span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="p">{</span><span class="w"></span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nt">"request_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"uuid-1"</span><span class="p">,</span><span class="w"></span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">"driver_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">1001</span><span class="p">,</span><span class="w"> </span><span class="mi">1002</span><span class="p">,</span><span class="w"> </span><span class="mi">1003</span><span class="p">,</span><span class="w"> </span><span class="mi">1004</span><span class="p">,</span><span class="w"> </span><span class="mi">1005</span><span class="p">]</span><span class="w"></span>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="p">}</span><span class="w"></span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="c1">// Response</span><span class="w"></span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="p">{</span><span class="w"></span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="nt">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">1001</span><span class="p">,</span><span class="w"></span>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Với mỗi driver id, model sẽ trả về 1 số thực. Số thực này thể hiện khả năng mà tài xế có hoàn thành hay không. Tuy nhiên, ở production, chúng ta không có label để biết chính xác số thực này hay khả năng này là bao nhiêu. Chúng ta chỉ biết rằng, với driver id là <code>1001</code> trả về bởi model, tài xế có id <code>1001</code> có hoàn thành cuốc xe hay không. Bảng dưới đây thể hiện kết quả dự đoán của model, tài xế được chọn, và thông tin cuốc xe có hoàn thành không, với mỗi request được gửi đến serving API.</p>
<table>
<thead>
<tr>
<th>request_id</th>
<th>Dự đoán của model</th>
<th>Tài xế được chọn</th>
<th>Hoàn thành</th>
</tr>
</thead>
<tbody>
<tr>
<td>uuid-1</td>
<td>0.1234</td>
<td>1001</td>
<td>1</td>
</tr>
<tr>
<td>uuid-2</td>
<td>1.2345</td>
<td>1001</td>
<td>0</td>
</tr>
<tr>
<td>uuid-3</td>
<td>-1.5678</td>
<td>1002</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Như các bạn thấy, mặc dù chúng ta có dự đoán của model, nhưng chúng ta không có label ở dạng số thực này để so sánh. Chúng ta chỉ biết tài xế được chọn, tức là dự đoán luôn là <code>1</code> cho tài xế được chọn. Cột <code>Hoàn thành</code> chính là label cho mỗi request. Như vậy, để test chức năng theo dõi model performance của monitoring service, chúng ta chỉ cần sinh ra labels cho mỗi request được gửi tới ở dạng 1/0 chứ không phải ở dạng số thực mà model trả về.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Cần sinh ra bao nhiêu request và label tương ứng?</p>
</div>
<p>Ở phần trước, chúng ta đã phân tích rằng chỉ cần tích luỹ 5 records là đủ để thực hiện quá trình so sánh data, nên số lượng request và label tương ứng chúng ta cần sinh ra 5 records. Dataset chứa 5 records này được gọi là <code>request_data</code>, gồm 3 cột:</p>
<ol>
<li><code>request_id</code>: request id</li>
<li><code>driver_ids</code>: danh sách các driver id được gửi đến trong request</li>
<li><code>trip_completed</code>: label cho request</li>
</ol>
<p>Giả sử tài xế <code>1001</code> luôn được dự đoán là tài xế có khả năng cao nhất sẽ hoàn thành cuốc xe, thì bộ features của tài xế <code>1001</code> sẽ luôn được gửi về monitoring service, khiến cho chúng ta không thể kiểm soát được phân phối của production data trong quá trình test monitoring service. Do đó, chúng ta cần đảm bảo cả 5 bộ features của 5 tài xế trong dataset mà chúng ta dùng (<code>normal_data</code> hoặc <code>drift_data</code>) đều được gửi tới Online serving API lần lượt. Điều này giúp cho phân phối của data trong 5 requests này giống với phân phối của cả dataset mà chúng ta dùng, giúp chúng ta kiểm soát được 2 trường hợp data không bị drift và bị drift. Bảng dưới đây là một ví dụ cho dataset <code>request_data</code>.</p>
<table>
<thead>
<tr>
<th>request_id</th>
<th>driver_ids</th>
<th>trip_completed</th>
</tr>
</thead>
<tbody>
<tr>
<td>uuid-1</td>
<td>[1001]</td>
<td>1</td>
</tr>
<tr>
<td>uuid-2</td>
<td>[1002]</td>
<td>0</td>
</tr>
<tr>
<td>uuid-3</td>
<td>[1003]</td>
<td>1</td>
</tr>
<tr>
<td>uuid-4</td>
<td>[1004]</td>
<td>0</td>
</tr>
<tr>
<td>uuid-5</td>
<td>[1005]</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Như vậy là chúng ta đã phân tích xong cách test monitoring service, với các bộ dataset cần được tạo ra bao gồm <code>normal_data</code>, <code>drift_data</code>, và <code>request_data</code>. Trong các phần dưới đây, chúng ta sẽ thực hiện viết code.</p>
<h2 id="tao-datasets">Tạo datasets</h2>
<p>Trong phần này, chúng ta sẽ sinh ra 2 datasets có tính chất và mục đích như bảng dưới đây.</p>
<table>
<thead>
<tr>
<th>Dataset</th>
<th>Phân phối</th>
<th>Số records</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>normal_data</code></td>
<td>Phân phối chuẩn, giá trị thuộc [0.05, 0.25]</td>
<td>5</td>
</tr>
<tr>
<td><code>drift_data</code></td>
<td>Phân phối chuẩn, giá trị thuộc [0.75, 0.95]</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>Code để sinh ra 2 datasets này nằm tại <code>monitoring_service/nbs/prepare_datasets.ipynb</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">monitoring_service/nbs/prepare_datasets.ipynb</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span>
<span class="normal"><a href="#__codelineno-2-26">26</a></span>
<span class="normal"><a href="#__codelineno-2-27">27</a></span>
<span class="normal"><a href="#__codelineno-2-28">28</a></span>
<span class="normal"><a href="#__codelineno-2-29">29</a></span>
<span class="normal"><a href="#__codelineno-2-30">30</a></span>
<span class="normal"><a href="#__codelineno-2-31">31</a></span>
<span class="normal"><a href="#__codelineno-2-32">32</a></span>
<span class="normal"><a href="#__codelineno-2-33">33</a></span>
<span class="normal"><a href="#__codelineno-2-34">34</a></span>
<span class="normal"><a href="#__codelineno-2-35">35</a></span>
<span class="normal"><a href="#__codelineno-2-36">36</a></span>
<span class="normal"><a href="#__codelineno-2-37">37</a></span>
<span class="normal"><a href="#__codelineno-2-38">38</a></span>
<span class="normal"><a href="#__codelineno-2-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">df_orig</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'fastparquet'</span><span class="p">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="n">driver_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_orig</span><span class="p">[</span><span class="s1">'driver_id'</span><span class="p">])</span> <span class="c1"># (1)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="n">N_SAMPLES</span> <span class="o">=</span> <span class="n">driver_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="n">X</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="n">N_SAMPLES</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_seed</span><span class="p">)</span> <span class="c1"># (2)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="n">X</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="c1"># (3)</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">))</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="n">X_shift</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="c1"># (4)</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">generated_X</span><span class="p">):</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">'conv_rate'</span><span class="p">]</span> <span class="o">=</span> <span class="n">generated_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># (5)</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">'acc_rate'</span><span class="p">]</span> <span class="o">=</span> <span class="n">generated_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">'avg_daily_trips'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">generated_X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># (6)</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a>    <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="c1"># Tạo normal_data và drift_data</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="n">normal_df</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="n">drift_df</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="c1"># Tạo request_data</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="n">request_id_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># (7)</span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="n">driver_ids_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SAMPLES</span><span class="p">):</span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a>    <span class="n">request_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"uuid-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a>    <span class="n">request_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a>    <span class="n">driver_id</span> <span class="o">=</span> <span class="n">driver_ids</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">driver_ids</span><span class="p">)]</span> <span class="c1"># (8)</span>
<a id="__codelineno-2-32" name="__codelineno-2-32"></a>    <span class="n">driver_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">driver_id</span><span class="p">])</span>
<a id="__codelineno-2-33" name="__codelineno-2-33"></a>
<a id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">N_SAMPLES</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span> <span class="c1"># (9)</span>
<a id="__codelineno-2-35" name="__codelineno-2-35"></a>
<a id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="n">request_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="c1"># (10)</span>
<a id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="n">request_df</span><span class="p">[</span><span class="s1">'request_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_id_list</span>
<a id="__codelineno-2-38" name="__codelineno-2-38"></a><span class="n">request_df</span><span class="p">[</span><span class="s1">'driver_ids'</span><span class="p">]</span> <span class="o">=</span> <span class="n">driver_ids_list</span>
<a id="__codelineno-2-39" name="__codelineno-2-39"></a><span class="n">request_df</span><span class="p">[</span><span class="s1">'trip_completed'</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Lấy ra các driver ids từ dataset gốc</li>
<li>Tạo ra 1 dataset cho bài toán classification theo phân phối chuẩn dựa vào hàm <code>make_classification</code> có sẵn của scikit-learn</li>
<li>Biến đổi <code>X</code> về đoạn [0.05, 0.25]. <code>X</code> sẽ được dùng để tạo <code>normal_data</code></li>
<li>Biến đổi <code>X</code> về đoạn [0.75, 0.95], lưu vào <code>X_shift</code>. <code>X_shift</code> sẽ được dùng để tạo <code>drift_data</code></li>
<li>Sử dụng 3 cột đầu tiên của <code>X</code> và <code>X_shift</code> để làm features cho <code>normal_data</code> và <code>drift_data</code></li>
<li>Feature <code>avg_daily_trips</code> nằm trong khoảng từ 0 tới 1000</li>
<li>Khởi tạo list chứa request ids và list chứa driver ids cho mỗi request</li>
<li>Lần lượt lấy ra các driver id trong list <code>driver_ids</code> chứa các driver ids từ dataset gốc</li>
<li>Sinh ra label cho mỗi request với xác suất 0.3 cho label <code>0</code> và 0.7 cho label <code>1</code>. 2 con số này có thể là bất kì</li>
<li>Tạo <code>DataFrame</code> chứa <code>request_data</code></li>
</ol>
<p>Như vậy là chúng ta vừa tạo xong <code>request_data</code> chứa thông tin về request sẽ được gửi tới Online serving API và label tương ứng của mỗi request. Tiếp theo, chúng ta sẽ test các datasets được sinh ra và cách sử dụng Evidently để phát hiện data drift và đánh giá model performance.</p>
<h3 id="test-datasets">Test datasets</h3>
<p>Trong phần này, chúng ta sẽ sử dụng Evidently để phát hiện data drift và theo dõi model performance của 2 datasets trên. Code của phần này được đặt tại <code>monitoring_service/nbs/test_datasets.ipynb</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">monitoring_service/nbs/test_datasets.ipynb</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span>
<span class="normal"><a href="#__codelineno-3-27">27</a></span>
<span class="normal"><a href="#__codelineno-3-28">28</a></span>
<span class="normal"><a href="#__codelineno-3-29">29</a></span>
<span class="normal"><a href="#__codelineno-3-30">30</a></span>
<span class="normal"><a href="#__codelineno-3-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">normal_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">ORIG_DATA_PATH</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'fastparquet'</span><span class="p">)</span> <span class="c1"># (1)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="n">drift_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">DRIFT_DATA_PATH</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'fastparquet'</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="n">request_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">REQUEST_DATA_PATH</span><span class="p">)</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="n">column_mapping</span> <span class="o">=</span> <span class="n">ColumnMapping</span><span class="p">(</span> <span class="c1"># (2)</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>    <span class="n">target</span><span class="o">=</span><span class="s2">"trip_completed"</span><span class="p">,</span> <span class="c1"># (3)</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="n">prediction</span><span class="o">=</span><span class="s2">"prediction"</span><span class="p">,</span> <span class="c1"># (4)</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>    <span class="n">numerical_features</span><span class="o">=</span><span class="p">[</span><span class="s2">"conv_rate"</span><span class="p">,</span> <span class="s2">"acc_rate"</span><span class="p">,</span> <span class="s2">"avg_daily_trips"</span><span class="p">],</span> <span class="c1"># (5)</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="n">categorical_features</span><span class="o">=</span><span class="p">[],</span> <span class="c1"># (6)</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="p">)</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="n">features_and_target_monitor</span> <span class="o">=</span> <span class="n">ModelMonitoring</span><span class="p">(</span><span class="n">monitors</span><span class="o">=</span><span class="p">[</span><span class="n">DataDriftMonitor</span><span class="p">()])</span> <span class="c1"># (7)</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="n">model_performance_monitor</span> <span class="o">=</span> <span class="n">ModelMonitoring</span><span class="p">(</span><span class="n">monitors</span><span class="o">=</span><span class="p">[</span><span class="n">ClassificationPerformanceMonitor</span><span class="p">()])</span> <span class="c1"># (8)</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="c1"># Chạy kiểm tra data drift</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="n">features_and_target_monitor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="c1"># (9)</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>    <span class="n">reference_data</span><span class="o">=</span><span class="n">normal_df</span><span class="p">,</span> <span class="c1"># (10)</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>    <span class="n">current_data</span><span class="o">=</span><span class="n">drift_df</span><span class="p">,</span> <span class="c1"># (11)</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>    <span class="n">column_mapping</span><span class="o">=</span><span class="n">column_mapping</span><span class="p">,</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="p">)</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="c1"># Chạy kiểm tra model performance</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="n">predictions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">drift_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="n">drift_df</span> <span class="o">=</span> <span class="n">drift_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prediction</span><span class="o">=</span><span class="n">predictions</span><span class="p">)</span> <span class="c1"># (12)</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="n">drift_df</span> <span class="o">=</span> <span class="n">drift_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">trip_completed</span><span class="o">=</span><span class="n">request_df</span><span class="p">[</span><span class="s2">"trip_completed"</span><span class="p">])</span> <span class="c1"># (13)</span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="n">model_performance_monitor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="c1"># (14)</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a>    <span class="n">reference_data</span><span class="o">=</span><span class="n">drift_df</span><span class="p">,</span>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a>    <span class="n">current_data</span><span class="o">=</span><span class="n">drift_df</span><span class="p">,</span>
<a id="__codelineno-3-30" name="__codelineno-3-30"></a>    <span class="n">column_mapping</span><span class="o">=</span><span class="n">column_mapping</span><span class="p">,</span>
<a id="__codelineno-3-31" name="__codelineno-3-31"></a><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Đọc <code>normal_data</code>, <code>drift_data</code>, và <code>request_data</code></li>
<li><code>ColumnMapping</code> là 1 class trong Evidently dùng để định nghĩa loại data của các cột của data</li>
<li>Định nghĩa cột <code>target</code>, hay chính là label</li>
<li>Định nghĩa cột <code>prediction</code>, hay chính là dự đoán của model</li>
<li>Định nghĩa các cột là features ở dạng số</li>
<li>Định nghĩa các cột là features ở dạng categorical</li>
<li>Định nghĩa 1 object <code>ModelMonitoring</code> để theo dõi data drift. <code>ModelMonitoring</code> là 1 class trong Evidently. Class này định nghĩa các loại monitoring mà chúng ta muốn chạy. Có nhiều loại monitoring như <code>DataDriftMonitor</code>, <code>CatTargetDriftMonitor</code>, <code>NumTargetDriftMonitor</code>, v.v.</li>
<li>Định nghĩa 1 object <code>ModelMonitoring</code> để theo dõi model performance</li>
<li>Chạy kiểm tra data drift, so sánh <code>drift_data</code> với <code>normal_data</code></li>
<li>Dùng <code>normal_data</code> làm <strong>reference window</strong>, hay training data. Trong Evidently, <strong>reference window</strong> được gán vào tham số <code>reference_data</code></li>
<li>Dùng <code>drift_data</code> làm <strong>test window</strong>, hay production data, để so sánh với training data. Trong Evidently, <strong>test window</strong> được gán vào tham số <code>current_data</code></li>
<li>Thêm cột <code>prediction</code> vào <code>drift_data</code>, hay chính là dự đoán của model. Như đã phân tích ở phần trước, predictions của model luôn là <code>1</code></li>
<li>Thêm cột <code>trip_completed</code> vào <code>drift_data</code>, hay chính là label của mỗi record</li>
<li>Chạy kiểm tra model performance, so sánh <code>drift_data</code> với chính nó</li>
</ol>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Tại sao chúng ta lại kiểm tra model performance bằng cách so sánh <code>drift_data</code>, hay production data, với chính nó?</p>
</div>
<p>Trong Evidently, với loại monitoring là <code>ClassificationPerformanceMonitor</code>, nếu cả <strong>reference window</strong> và <strong>test window</strong> đều chứa prediction và label, thì Evidently sẽ tính toán các metrics cho model performance trên cả 2 datasets này, và thực hiện so sánh xem các metrics đó khác nhau thế nào. Tuy nhiên, để đơn giản hoá, chúng ta chỉ cần biết model performance của model với production data, chứ không cần so sánh model performance giữa <strong>reference window</strong> và <strong>test window</strong>. Và vì <code>drift_data</code> đã chứa thông tin về prediction và label, nên chúng ta sẽ truyền vào <code>drift_data</code> cho cả 2 loại datasets này.</p>
<p>Kết quả được in ra sau khi chạy sẽ giống như sau.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>data_drift:n_drifted_features <span class="p">|</span> <span class="m">3</span> <span class="p">|</span> None <span class="c1"># (1)</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>data_drift:dataset_drift <span class="p">|</span> True <span class="p">|</span> None <span class="c1"># (2)</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>...
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>classification_performance:quality <span class="p">|</span> <span class="m">0</span>.4 <span class="p">|</span> <span class="o">{</span><span class="s1">'dataset'</span>: <span class="s1">'reference'</span>, <span class="s1">'metric'</span>: <span class="s1">'accuracy'</span><span class="o">}</span> <span class="c1"># (3)</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>classification_performance:class_quality <span class="p">|</span> <span class="m">0</span>.0 <span class="p">|</span> <span class="o">{</span><span class="s1">'dataset'</span>: <span class="s1">'reference'</span>, <span class="s1">'class_name'</span>: <span class="s1">'0'</span>, <span class="s1">'metric'</span>: <span class="s1">'precision'</span><span class="o">}</span> <span class="c1"># (4)</span>
<a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>...
</code></pre></div>
<ol>
<li>Số features bị drift</li>
<li><strong>test window</strong> có bị drift không</li>
<li><code>accuracy</code> của model</li>
<li><code>precision</code> của model cho class <code>0</code></li>
</ol>
<p>Để tìm hiểu thêm về các loại monitoring khác hay các chức năng khác của Evidently, các bạn có thể xem thêm các ví dụ tại <a href="https://docs.evidentlyai.com/examples">website của Evidently</a>.</p>
<h2 id="monitoring-service">Monitoring service</h2>
<p>Trong phần này, chúng ta sẽ phát triển monitoring service. Hình dưới đây thể hiện các luồng data của monitoring service.</p>
<pre class="mermaid"><code>    flowchart LR
        n01[ ] --Label--&gt; n2
        n0[Client] --Request--&gt; n1[Online serving&lt;br&gt;service] --Features &amp;&lt;br&gt;prediction--&gt; n2[Monitoring&lt;br&gt;service] --Metrics--&gt; n3[Prometheus&lt;br&gt;&amp; Grafana]
        n1 --Response--&gt; n0

        style n01 height:0px;</code></pre>
<p>Như hình trên, quá trình phát triển monitoring service bao gồm các bước chính sau.</p>
<ol>
<li>Viết code để gửi request và response data từ Online serving API sang <em>Monitoring API</em> của monitoring service, với features được lấy từ dataset <code>normal_data</code> hoặc <code>drift_data</code>, và request data được đọc từ dataset <code>request_data</code></li>
<li>Viết Monitoring API ở monitoring service, nhận data từ Online serving API, dùng data này để theo dõi data drift và model performance, với label được đọc từ dataset <code>request_data</code></li>
<li>Thiết lập Prometheus server và Grafana dashboards để hiển thị các metrics liên quan tới data drift và model performance</li>
</ol>
<h3 id="monitoring-api">Monitoring API</h3>
<p>Đầu tiên, chúng ta sẽ viết Monitoring API ở monitoring service trước. Code của monitoring service được đặt tại <code>monitoring_service/src/monitoring_service.py</code>. Các bạn hãy để ý tới hàm <code>iterate</code> của class <code>MonitoringService</code> với luồng xử lý data như sau.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">monitoring_service/src/monitoring_service.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span>
<span class="normal"><a href="#__codelineno-5-4">4</a></span>
<span class="normal"><a href="#__codelineno-5-5">5</a></span>
<span class="normal"><a href="#__codelineno-5-6">6</a></span>
<span class="normal"><a href="#__codelineno-5-7">7</a></span>
<span class="normal"><a href="#__codelineno-5-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_rows</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span> <span class="c1"># (1)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_curr_data</span><span class="p">(</span><span class="n">new_rows</span><span class="p">):</span> <span class="c1"># (2)</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>        <span class="k">return</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_next_run</span><span class="p">():</span> <span class="c1"># (3)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>        <span class="k">return</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_execute_monitoring</span><span class="p">()</span> <span class="c1"># (4)</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_process_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_and_target_monitor</span><span class="o">.</span><span class="n">metrics</span><span class="p">())</span> <span class="c1"># (5)</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_process_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_performance_monitor</span><span class="o">.</span><span class="n">metrics</span><span class="p">())</span> <span class="c1"># (6)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Hàm <code>iterate</code> nhận vào <code>new_rows</code>, chính là data được Online serving API gửi tới</li>
<li>Xử lý data nhận được</li>
<li>Kiểm tra xem đã đến thời điểm chạy quá trình đánh giá data drift và model performance chưa</li>
<li>Bắt đầu phân tích đánh giá data drift và model performance</li>
<li>Gửi metrics của data drift tới Prometheus server</li>
<li>Gửi metrics của model performance tới Prometheus server</li>
</ol>
<p>Data nhận được từ Online serving API bao gồm các cột chính như sau.</p>
<table>
<thead>
<tr>
<th>Cột</th>
<th>Ý nghĩa</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>request_id</code></td>
<td>Request ID</td>
</tr>
<tr>
<td><code>conv_rate</code></td>
<td>Feature</td>
</tr>
<tr>
<td><code>acc_rate</code></td>
<td>Feature</td>
</tr>
<tr>
<td><code>avg_daily_trips</code></td>
<td>Feature</td>
</tr>
<tr>
<td><code>best_driver_id</code></td>
<td>Driver ID được chọn</td>
</tr>
<tr>
<td><code>prediction</code></td>
<td>Prediction cho driver ID được chọn</td>
</tr>
</tbody>
</table>
<p>Bây giờ, hãy cùng xem hàm <code>_process_curr_data</code> làm công việc gì.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">monitoring_service/src/monitoring_service.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">def</span> <span class="nf">_process_curr_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_rows</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span> <span class="c1"># (1)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="n">label_data</span> <span class="o">=</span> <span class="n">read_label_data</span><span class="p">()</span> <span class="c1"># (2)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>    <span class="k">if</span> <span class="n">label_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>    <span class="n">merged_data</span> <span class="o">=</span> <span class="n">merge_request_with_label</span><span class="p">(</span><span class="n">new_rows</span><span class="p">,</span> <span class="n">label_data</span><span class="p">)</span> <span class="c1"># (3)</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># (4)</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>        <span class="n">curr_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">current_data</span><span class="p">,</span> <span class="n">merged_data</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>        <span class="n">curr_data</span> <span class="o">=</span> <span class="n">merged_data</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>    <span class="n">curr_size</span> <span class="o">=</span> <span class="n">curr_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a>    <span class="k">if</span> <span class="n">curr_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">WINDOW_SIZE</span><span class="p">:</span> <span class="c1"># (5)</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>        <span class="n">curr_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>            <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">curr_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">WINDOW_SIZE</span><span class="p">)),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>        <span class="p">)</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>        <span class="n">curr_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">current_data</span> <span class="o">=</span> <span class="n">curr_data</span> <span class="c1"># (6)</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a>    <span class="k">if</span> <span class="n">curr_size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">WINDOW_SIZE</span><span class="p">:</span> <span class="c1"># (7)</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>        <span class="n">Log</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a>            <span class="sa">f</span><span class="s2">"Not enough data for measurement: </span><span class="si">{</span><span class="n">curr_size</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">WINDOW_SIZE</span><span class="si">}</span><span class="s2"> rows. Waiting for more data"</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a>        <span class="p">)</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a>    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Hàm <code>_process_curr_data</code> nhận vào <code>DataFrame</code> được gửi từ Online serving API sang</li>
<li>Đọc label data, hay chính là <code>request_data</code> mà chúng ta đã tạo ra ở trên</li>
<li>Kết hợp data mới nhận được với label data theo <code>request_id</code></li>
<li>Tích luỹ data mới với data hiện tại</li>
<li>Bỏ bớt data nếu như số records vượt quá <code>WINDOW_SIZE</code>, được định nghĩa là số lượng các records chúng ta muốn tích luỹ để thực hiện monitoring</li>
<li>Lưu lại data mới đã được xử lý vào làm data hiện tại</li>
<li>Kiểm tra xem đã đủ số records cần thiết chưa</li>
</ol>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Tại sao chúng ta cần đọc label data, hay <code>request_data</code>, mỗi khi có records mới được gửi đến từ Online serving API?</p>
</div>
<p>Thực ra chúng ta không cần phải đọc lại <code>request_data</code> mỗi khi có records mới. Sở dĩ mình viết code như vậy là để giả sử rằng không phải lúc nào label cũng có sẵn ở production.</p>
<p>Sau khi kết hợp data mới nhận được với label data theo <code>request_id</code>, chúng ta sẽ có một record chứa các cột sau:</p>
<ul>
<li>Các cột features: dùng để theo dõi data drift</li>
<li>Cột <code>prediction</code> và cột label <code>trip_completed</code>: dùng để theo dõi model performance. Lưu ý rằng cột <code>prediction</code> đã được biến đổi trong hàm <code>merge_request_with_label</code> để luôn có giá trị là <code>1</code></li>
</ul>
<p>Tiếp đến, hãy cùng xem hàm <code>_process_next_run</code> và hàm <code>_execute_monitoring</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">monitoring_service/src/monitoring_service.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">def</span> <span class="nf">_process_next_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">():</span> <span class="c1"># (1)</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RUN_PERIOD_SEC</span><span class="p">)</span> <span class="c1"># (2)</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>    <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="k">def</span> <span class="nf">_execute_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">features_and_target_monitor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="c1"># (3)</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reference_data</span><span class="p">,</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_data</span><span class="p">,</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">column_mapping</span><span class="p">,</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>    <span class="p">)</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model_performance_monitor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="c1"># (4)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_data</span><span class="p">,</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_data</span><span class="p">,</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">column_mapping</span><span class="p">,</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Kiểm tra xem thời điểm hiện tại có chạy monitoring không</li>
<li>Tính thời điểm tiếp theo sẽ chạy monitoring</li>
<li>Thực hiện đánh giá data drift, giống như chúng ta đã thực hiện ở file notebook <code>monitoring_service/nbs/test_datasets.ipynb</code></li>
<li>Thực hiện đánh giá model performance</li>
</ol>
<p>Cuối cùng, đoạn code dưới đây của hàm <code>_process_metrics</code> sẽ gửi metrics của data drift và model performance tới Prometheus server.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">monitoring_service/src/monitoring_service.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">def</span> <span class="nf">_process_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evidently_metrics</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">evidently_metrics</span><span class="p">:</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>        <span class="n">metric_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"evidently:</span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span> <span class="c1"># (1)</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">labels</span><span class="p">:</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>        <span class="n">labels</span><span class="p">[</span><span class="s2">"dataset_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">MonitoringService</span><span class="o">.</span><span class="n">DATASET_NAME</span> <span class="c1"># (2)</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>            <span class="k">continue</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>        <span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_key</span><span class="p">)</span> <span class="c1"># (3)</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>        <span class="k">if</span> <span class="n">found</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>            <span class="n">found</span> <span class="o">=</span> <span class="n">prometheus_client</span><span class="o">.</span><span class="n">Gauge</span><span class="p">(</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>                <span class="n">metric_key</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a>            <span class="p">)</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">found</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a>            <span class="n">found</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="o">**</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="c1"># (4)</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a>        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a>            <span class="o">...</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Tạo tên metric. Tên metric này phải giống với các metric mà chúng ta sẽ hiển thị trên Grafana dashboards</li>
<li><code>labels</code> là một <code>dict</code> với key và value là tên và giá trị của các label được quy ước bởi Evidently, ví dụ <code>{'dataset': 'reference', 'metric': 'accuracy'}</code>. <code>labels</code> này tương đương với <a href="https://prometheus.io/docs/practices/naming/#labels">Prometheus labels</a></li>
<li><code>self.metrics</code> lưu các object <code>Gauge</code> của Prometheus. <code>Gauge</code> giúp chúng ta gửi metrics tới Prometheus server. Biến <code>found</code> là một object <code>Gauge</code>, tương ứng với mỗi metric lấy ra từ Evidently</li>
<li>Gán Prometheus labels và giá trị cho <code>Gauge</code> object. Dòng code này sẽ gửi labels và giá trị của các metrics lên Prometheus server</li>
</ol>
<p>Như vậy là chúng ta vừa tìm hiểu các đoạn code quan trọng nhất của monitoring service. Các đoạn code còn lại khác mà các bạn cần lưu ý như dưới đây.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">monitoring_service/src/monitoring_service.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">AppConst</span><span class="o">.</span><span class="n">MONITORING_SERVICE</span><span class="p">)</span> <span class="c1"># (1)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="o">...</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="n">app</span><span class="o">.</span><span class="n">wsgi_app</span> <span class="o">=</span> <span class="n">DispatcherMiddleware</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">,</span> <span class="p">{</span><span class="s2">"/metrics"</span><span class="p">:</span> <span class="n">prometheus_client</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()})</span> <span class="c1"># (2)</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="o">...</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="n">SERVICE</span> <span class="o">=</span> <span class="n">MonitoringService</span><span class="p">()</span> <span class="c1"># (3)</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="o">...</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/iterate"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"POST"</span><span class="p">])</span> <span class="c1"># (4)</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="k">def</span> <span class="nf">iterate</span><span class="p">():</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>    <span class="n">item</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="c1"># (5)</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>    <span class="n">SERVICE</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">new_rows</span><span class="o">=</span><span class="n">df</span><span class="p">)</span> <span class="c1"># (6)</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>    <span class="k">return</span> <span class="s2">"ok"</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="o">...</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">"0.0.0.0"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8309</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># (7)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Tạo Flask app. Flask là một công cụ phổ biến được dùng để viết RESTful API cho Python</li>
<li>Tự động tạo endpoint <code>/metrics</code> để Prometheus thu thập metrics</li>
<li>Khởi tạo <code>MonitoringService</code> class</li>
<li>Tạo endpoint <code>/iterate</code> để Online serving API gửi data tới</li>
<li>Biến đổi data nhận vào thành <code>DataFrame</code></li>
<li>Gọi hàm <code>iterate</code> để thực hiện đánh giá data drift và model performance</li>
<li>Chạy Flask app ở port <code>8309</code> ở máy local</li>
</ol>
<p>Để Prometheus có thể thu thập metrics được gửi qua endpoint <code>/metrics</code>, chúng ta cần phải tạo 1 Prometheus Job trong file config của Prometheus server được đặt tại <code>prom-graf/prometheus/config/prometheus.yml</code> trong repo <code>mlops-crash-course-platform</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">prom-graf/prometheus/config/prometheus.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span>
<span class="normal"><a href="#__codelineno-10-4">4</a></span>
<span class="normal"><a href="#__codelineno-10-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">"monitoring_service"</span><span class="w"></span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span><span class="w"></span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">  </span><span class="nt">static_configs</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"localhost:8309"</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Sau khi code xong monitoring service, chúng ta sẽ viết thêm code cho Online serving API để nó gửi data sau khi thực hiện prediction sang Monitoring API.</p>
<h3 id="tich-hop-online-serving">Tích hợp Online serving</h3>
<p>Các bạn hãy mở file code của Online serving API tại <code>model_serving/src/bentoml_service.py</code> trong repo <code>mlops-crash-course-code</code>. Hãy chú ý tới đoạn code trong hàm <code>inference</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">model_serving/src/bentoml_service.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="nd">@svc</span><span class="o">.</span><span class="n">api</span><span class="p">(</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>    <span class="o">...</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="p">)</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">InferenceRequest</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">bentoml</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>        <span class="o">...</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">input_features</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">input_features</span><span class="p">)])</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">"prediction"</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>        <span class="n">best_idx</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"prediction"</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span> <span class="c1"># (1)</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>        <span class="n">best_driver_id</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"driver_id"</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span> <span class="c1"># (2)</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>        <span class="c1"># monitor</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a>        <span class="n">monitor_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">best_idx</span><span class="p">]]</span> <span class="c1"># (3)</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a>        <span class="n">monitor_df</span> <span class="o">=</span> <span class="n">monitor_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">request_id</span><span class="o">=</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">request_id</span><span class="p">])</span> <span class="c1"># (4)</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>        <span class="n">monitor_df</span> <span class="o">=</span> <span class="n">monitor_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">best_driver_id</span><span class="o">=</span><span class="p">[</span><span class="n">best_driver_id</span><span class="p">])</span> <span class="c1"># (5)</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>        <span class="n">monitor_request</span><span class="p">(</span><span class="n">monitor_df</span><span class="p">)</span> <span class="c1"># (6)</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a>        <span class="o">...</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="k">def</span> <span class="nf">monitor_request</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span> <span class="c1"># (7)</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="bp">cls</span><span class="o">=</span><span class="n">NumpyEncoder</span><span class="p">)</span> <span class="c1"># (8)</span>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span> <span class="c1"># (9)</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a>            <span class="n">MONITORING_SERVICE_API</span><span class="p">,</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a>            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">"content-type"</span><span class="p">:</span> <span class="s2">"application/json"</span><span class="p">},</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a>        <span class="p">)</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a>        <span class="o">...</span>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a>        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Lấy ra index của tài xế có khả năng cao nhất sẽ hoàn thành cuốc xe</li>
<li>Lấy ra ID của tài xế được chọn</li>
<li>Lấy ra hàng trong <code>DataFrame</code> gốc của tài xế được chọn</li>
<li>Thêm cột <code>request_id</code> vào <code>monitor_df</code>, với giá trị là <code>request_id</code> được gửi tới trong request</li>
<li>Thêm cột <code>best_driver_id</code> vào. Việc lưu trữ lại thông tin về dự đoán của model là cần thiết, giúp cho việc thu thập data và debug ở production dễ dàng hơn</li>
<li>Gọi tới hàm <code>monitor_request</code> để gửi data tới Monitoring API. Data được gửi bao gồm các chính sau: <code>request_id</code>, các features, <code>prediction</code>, và <code>best_driver_id</code></li>
<li>Hàm <code>monitor_request</code> làm nhiệm vụ gửi data tới Monitoring API</li>
<li>Biến đổi <code>DataFrame</code> thành dạng JSON với sự hỗ trợ của <code>NumpyEncoder</code> class, giúp cho việc biến đổi JSON trở lại thành <code>DataFrame</code> ở phía Monitoring API dễ dàng hơn</li>
<li>Gửi POST request tới Monitoring API với data vừa biến đổi ở trên</li>
</ol>
<p>Như vậy là chúng ta vừa tích hợp Online serving API với Monitoring API của Monitoring service. Sau khi model thực hiện prediction ở Online serving API, data được tổng hợp từ request gửi đến và prediction của model sẽ được gửi sang Monitoring API để được theo dõi và đánh giá. Monitoring API sẽ thực hiện việc đánh giá data drift, model performance, rồi gửi các metrics đánh giá được ra API endpoint <code>/metrics</code>. Prometheus server sẽ định kì thu thập các metrics này qua endpoint <code>/metrics</code>. Grafana sẽ đọc các metrics từ Prometheus server và hiển thị lên dashboards. Trong phần tiếp theo, chúng ta sẽ thiết lập Grafana dashboards để hiển thị các metrics này.</p>
<h2 id="grafana-dashboards-va-alerts">Grafana dashboards và Alerts</h2>
<p>Có 2 dashboards chúng ta cần thiết lập. 2 dashboards này bao gồm:</p>
<ol>
<li><code>monitoring_service/dashboards/data_drift.json</code>: Dashboard cho metrics về data drift</li>
<li><code>monitoring_service/dashboards/classification_performance.json</code>: Dashboard cho metrics về model performance</li>
</ol>
<p>Giống như ở bài trước <a href="../metrics-he-thong">Metrics hệ thống</a>, các bạn cần làm các bước sau để triển khai các dashboards này lên Grafana.</p>
<ol>
<li>Copy 2 file dashboards trên vào <code>mlops-crash-course-platform/prom-graf/run_env/grafana/dashboards</code></li>
<li>Truy cập vào Grafana server tại <a href="http://localhost:3000">http://localhost:3000</a></li>
<li>Mở 2 file dashboards có tên <strong>Evidently Data Drift Dashboard</strong> và <strong>Evidently Classification Performance Dashboard</strong></li>
</ol>
<h3 id="data-drift-dashboard">Data Drift Dashboard</h3>
<p>Dashboard <strong>Evidently Data Drift Dashboard</strong> sẽ giống như hình dưới đây.</p>
<p><a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/drift-dashboard-no-data.png"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/drift-dashboard-no-data.png"/></a></p>
<p>Dashboard này chứa các panels về data drift bao gồm.</p>
<ul>
<li>
<p><code>General information</code></p>
<ul>
<li><code>Dataset drift</code>: Dataset có bị drift hay không</li>
<li><code>Share of drifted features</code>: Tỉ lệ số features bị drift trên tổng số features</li>
<li><code># of drifted features</code>: Số features bị drift</li>
<li><code># of features</code>: Tổng số features</li>
</ul>
</li>
<li>
<p><code>Detailed information</code></p>
<ul>
<li><code>P-value of features</code>: <a href="https://en.wikipedia.org/wiki/P-value">p-value</a> của các features</li>
</ul>
</li>
</ul>
<h3 id="model-performance-dashboard">Model Performance Dashboard</h3>
<p>Dashboard <strong>Evidently Classification Performance Dashboard</strong> sẽ giống như hình dưới đây.</p>
<p><a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/model-performance-no-data.png"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/model-performance-no-data.png"/></a></p>
<p>Dashboard này chứa các panels về model performance bao gồm.</p>
<ul>
<li>
<p><code>Reference dataset data</code></p>
<ul>
<li><code>Quality</code>: Tổng hợp các model performance metrics theo thời gian</li>
<li><code>accuracy</code>, <code>f1</code>, <code>precision</code>, <code>recall</code>: Các model performance metrics</li>
<li><code>Prediction class representation</code>: Số lượng các prediction theo class</li>
<li><code>Target class representation</code>: Số lượng các label theo class</li>
</ul>
</li>
<li>
<p><code>Class 0 information</code>: Thông tin về class 0</p>
<ul>
<li><code>Confusion 0</code>: Confusion matrix cho class 0</li>
<li><code>Confusion in time</code>: Các giá trị của confusion matrix theo thời gian</li>
<li><code>Quality</code>: Tổng hợp các model performance metrics cho class 0 theo thời gian</li>
</ul>
</li>
<li>
<p><code>Class 1 information</code>: Tương tự class 0</p>
</li>
</ul>
<h3 id="alerts">Alerts</h3>
<p>Grafana Alerting cho phép chúng ta có thể kích hoạt cảnh báo khi một vấn đề về metrics xảy ra. Trong bài này, chúng ta sẽ tạo một Alert đơn giản trong Grafana để cảnh báo khi dataset bị drift.</p>
<ol>
<li>
<p>Ở sidebar bên phải của Grafana, các bạn click vào <code>Dashabords</code>. Ở trang Dashboard, tạo Folder tên là <code>Alerts</code>. Folder này được dùng để lưu Alert chúng ta sẽ tạo</p>
<p><a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/alert-folder.png"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/alert-folder.png"/></a></p>
</li>
<li>
<p>Ở sidebar bên phải của Grafana, các bạn click vào <code>Alerting</code>. Trong giao diện của trang <code>Alerting</code>, tab <code>Alert rules</code>, các bạn click nút <code>New alert rule</code>.</p>
<p><a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/new-alert.png"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/new-alert.png"/></a></p>
</li>
<li>
<p>Trong trang tạo alert rule mới tên là <code>Data drift detection</code>, các bạn điền các thông tin trong phần <code>1. Set a query and alert condition</code> như ảnh dưới, với query <code>A</code> là:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="nv">evidently</span><span class="err">:</span><span class="nv">data_drift</span><span class="err">:</span><span class="nv">dataset_drift</span><span class="p">{</span><span class="nl">dataset_name</span><span class="o">=</span><span class="p">"</span><span class="s">drivers</span><span class="p">"}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/alert-1.png"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/alert-1.png"/></a></p>
</li>
<li>
<p>Phần <code>2. Alert evaluation behavior</code> và <code>3. Add details for your alert</code></p>
<p><a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/alert-2-3.png"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/alert-2-3.png"/></a></p>
</li>
<li>
<p>Click <code>Save and exit</code></p>
</li>
</ol>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Để cấu hình cách mà Alert được gửi đi, các bạn vào tab <code>Notification polices</code> và thêm policy mới. Trong khoá học này, để đơn giản, chúng ta sẽ giữ nguyên policy mặc định của Grafana.</p>
</div>
<h2 id="thu-nghiem">Thử nghiệm</h2>
<h3 id="data-bi-drift">Data bị drift</h3>
<p>Sau khi thiết lập xong các dashboards, trong phần này chúng ta sẽ viết code để gửi request chứa <code>normal_data</code> và <code>drift_data</code> tới Online serving API. Code để gửi các requests được đặt tại <code>monitoring_service/src/mock_request.py</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">monitoring_service/src/mock_request.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span>
<span class="normal"><a href="#__codelineno-13-18">18</a></span>
<span class="normal"><a href="#__codelineno-13-19">19</a></span>
<span class="normal"><a href="#__codelineno-13-20">20</a></span>
<span class="normal"><a href="#__codelineno-13-21">21</a></span>
<span class="normal"><a href="#__codelineno-13-22">22</a></span>
<span class="normal"><a href="#__codelineno-13-23">23</a></span>
<span class="normal"><a href="#__codelineno-13-24">24</a></span>
<span class="normal"><a href="#__codelineno-13-25">25</a></span>
<span class="normal"><a href="#__codelineno-13-26">26</a></span>
<span class="normal"><a href="#__codelineno-13-27">27</a></span>
<span class="normal"><a href="#__codelineno-13-28">28</a></span>
<span class="normal"><a href="#__codelineno-13-29">29</a></span>
<span class="normal"><a href="#__codelineno-13-30">30</a></span>
<span class="normal"><a href="#__codelineno-13-31">31</a></span>
<span class="normal"><a href="#__codelineno-13-32">32</a></span>
<span class="normal"><a href="#__codelineno-13-33">33</a></span>
<span class="normal"><a href="#__codelineno-13-34">34</a></span>
<span class="normal"><a href="#__codelineno-13-35">35</a></span>
<span class="normal"><a href="#__codelineno-13-36">36</a></span>
<span class="normal"><a href="#__codelineno-13-37">37</a></span>
<span class="normal"><a href="#__codelineno-13-38">38</a></span>
<span class="normal"><a href="#__codelineno-13-39">39</a></span>
<span class="normal"><a href="#__codelineno-13-40">40</a></span>
<span class="normal"><a href="#__codelineno-13-41">41</a></span>
<span class="normal"><a href="#__codelineno-13-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">def</span> <span class="nf">construct_request</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span> <span class="c1"># (1)</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>    <span class="n">request_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"request_id"</span><span class="p">]</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>    <span class="n">driver_ids</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">"driver_ids"</span><span class="p">])</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a>        <span class="s2">"request_id"</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>        <span class="s2">"driver_ids"</span><span class="p">:</span> <span class="n">driver_ids</span><span class="p">,</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>    <span class="p">}</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="k">def</span> <span class="nf">send_request</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># (2)</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a>            <span class="n">ONLINE_SERVING_API</span><span class="p">,</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a>            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a>            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">"content-type"</span><span class="p">:</span> <span class="s2">"application/json"</span><span class="p">},</span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a>        <span class="p">)</span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a>        <span class="o">...</span>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a>        <span class="o">...</span>
<a id="__codelineno-13-20" name="__codelineno-13-20"></a>
<a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_request</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span> <span class="c1"># (3)</span>
<a id="__codelineno-13-22" name="__codelineno-13-22"></a>    <span class="n">data_path</span> <span class="o">=</span> <span class="n">AppPath</span><span class="o">.</span><span class="n">NORMAL_DATA</span>
<a id="__codelineno-13-23" name="__codelineno-13-23"></a>    <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="n">DataType</span><span class="o">.</span><span class="n">DRIFT</span><span class="p">:</span>
<a id="__codelineno-13-24" name="__codelineno-13-24"></a>        <span class="n">data_path</span> <span class="o">=</span> <span class="n">AppPath</span><span class="o">.</span><span class="n">DRIFT_DATA</span>
<a id="__codelineno-13-25" name="__codelineno-13-25"></a>    <span class="n">data_source</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">"fastparquet"</span><span class="p">)</span> <span class="c1"># (4)</span>
<a id="__codelineno-13-26" name="__codelineno-13-26"></a>    <span class="n">request_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">AppPath</span><span class="o">.</span><span class="n">REQUEST_DATA</span><span class="p">)</span> <span class="c1"># (5)</span>
<a id="__codelineno-13-27" name="__codelineno-13-27"></a>    <span class="o">...</span>
<a id="__codelineno-13-28" name="__codelineno-13-28"></a>    <span class="n">data_source</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">AppPath</span><span class="o">.</span><span class="n">FEAST_DATA_SOURCE</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">"fastparquet"</span><span class="p">)</span> <span class="c1"># (6)</span>
<a id="__codelineno-13-29" name="__codelineno-13-29"></a>
<a id="__codelineno-13-30" name="__codelineno-13-30"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">"make"</span><span class="p">,</span> <span class="s2">"feast_teardown"</span><span class="p">])</span> <span class="c1"># (7)</span>
<a id="__codelineno-13-31" name="__codelineno-13-31"></a>    <span class="o">...</span>
<a id="__codelineno-13-32" name="__codelineno-13-32"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">"make"</span><span class="p">,</span> <span class="s2">"feast_apply"</span><span class="p">])</span> <span class="c1"># (8)</span>
<a id="__codelineno-13-33" name="__codelineno-13-33"></a>    <span class="o">...</span>
<a id="__codelineno-13-34" name="__codelineno-13-34"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">"make"</span><span class="p">,</span> <span class="s2">"feast_materialize"</span><span class="p">])</span> <span class="c1"># (9)</span>
<a id="__codelineno-13-35" name="__codelineno-13-35"></a>    <span class="o">...</span>
<a id="__codelineno-13-36" name="__codelineno-13-36"></a>
<a id="__codelineno-13-37" name="__codelineno-13-37"></a>    <span class="n">total_request</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-13-38" name="__codelineno-13-38"></a>    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_request</span><span class="p">):</span>
<a id="__codelineno-13-39" name="__codelineno-13-39"></a>        <span class="n">row</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span> <span class="o">%</span> <span class="n">total_request</span><span class="p">]</span>
<a id="__codelineno-13-40" name="__codelineno-13-40"></a>        <span class="n">request</span> <span class="o">=</span> <span class="n">construct_request</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<a id="__codelineno-13-41" name="__codelineno-13-41"></a>        <span class="n">send_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="c1"># (10)</span>
<a id="__codelineno-13-42" name="__codelineno-13-42"></a>        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Hàm <code>construct_request</code> tạo payload dạng JSON để gửi tới Online serving API</li>
<li>Hàm <code>send_request</code> gửi payload được tạo bởi hàm <code>construct_request</code> tới Online serving API</li>
<li>Hàm <code>main</code> thực hiện quá trình gửi data</li>
<li>Đọc dataset chứa các features, tuỳ thuộc vào loại data là <code>normal_data</code> hay <code>drift_data</code></li>
<li>Đọc <code>request_data</code></li>
<li>Ghi đè dataset chứa các features vào file data source của Feast</li>
<li>Xoá data ở cả Offline Feature Store và Online Feature Store</li>
<li>Ghi data từ file data source của Feast vào Offline Feature Store</li>
<li>Ghi data từ Offline Feature Store vào Online Feature Store</li>
<li>Gửi lần lượt các request trong <code>request_data</code> tới Online serving API</li>
</ol>
<p>Để tiến hành thử nghiệm, các bạn hãy làm theo các bước sau.</p>
<ol>
<li>Đảm bảo rằng <a href="../../model-serving/trien-khai-model-serving/#online-serving">Online serving service</a> đã chạy</li>
<li>
<p>Build docker image và chạy docker compose cho monitoring service</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a>make build_image
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a>make compose_up
</code></pre></div>
</li>
<li>
<p>Gửi 5 requests giả chứa <code>drift_data</code></p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a>python src/mock_request.py -d drift -n <span class="m">5</span>
</code></pre></div>
</li>
</ol>
<p>Sau khi các requests được gửi xong, các bạn hãy kiểm tra <strong>Evidently Data Drift Dashboard</strong> và <strong>Evidently Classification Performance Dashboard</strong>, kết quả sẽ giống như sau.</p>
<figure>
<a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/drift-dashboard-drifted.png"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/drift-dashboard-drifted.png"/></a>
<figcaption>Evidently Data Drift Dashboard - Dataset drift</figcaption>
</figure>
<figure>
<a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/model-performance-with-data.png"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/model-performance-with-data.png"/></a>
<figcaption>Evidently Classification Performance Dashboard</figcaption>
</figure>
<p>Các bạn mở trang Alerting trong Grafana và sẽ thấy Alert <code>Data drift detection</code> mà chúng ta tạo ở trên đang ở trạng thái <code>Firing</code>.</p>
<p><a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/alert-firing.png"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/alert-firing.png"/></a></p>
<p>Các bạn có thể click vào nút <code>Show state history</code> để xem thời điểm của các trạng thái của Alert này.</p>
<p><a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/alert-history.png"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/alert-history.png"/></a></p>
<h3 id="data-khong-bi-drift">Data không bị drift</h3>
<p>Tiếp theo, chúng ta sẽ gửi 5 requests giả chứa <code>normal_data</code> tới Online serving API bằng cách chạy lệnh sau.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a>python src/mock_request.py -d normal -n <span class="m">5</span>
</code></pre></div>
<p>Sau khi gửi xong, các bạn hãy kiểm tra <strong>Evidently Data Drift Dashboard</strong> sẽ thấy thông tin Dataset không bị drift, số drifted features là 0. Ngoài ra, alert <code>Data drift detection</code> cũng đã ở trạng thái <code>Normal</code>.</p>
<figure>
<a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/drift-dashboard-normal.png"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/drift-dashboard-normal.png"/></a>
<figcaption>Evidently Data Drift Dashboard - Dataset không drift</figcaption>
</figure>
<figure>
<a class="glightbox" href="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/alert-normal.png"><img loading="lazy" src="../../../assets/images/mlops-crash-course/monitoring/monitoring-service/alert-normal.png"/></a>
<figcaption>Alert Data drift detection ở trạng thái Normal</figcaption>
</figure>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Nếu các bạn mở Kibana ra, các bạn cũng sẽ thấy logs của Monitoring service được tự động thu thập nhờ chức năng tự động thu thập logs từ các containers của Filebeat</p>
</div>
<h2 id="tong-ket">Tổng kết</h2>
<p>Theo dõi và bảo trì luôn luôn là một phần quan trọng trong quá trình phát triển một hệ thống phần mềm. Trong bài hướng dẫn <strong>Monitoring</strong> này, chúng ta đã được học về các metrics điển hình liên quan tới hệ thống, data, và model mà một hệ thống ML thường sẽ theo dõi.</p>
<p>Chúng ta cũng đã phân tích và thiết kế một service khá phức tạp là Monitoring service. Các bạn đã hiểu các yêu cầu về tính năng thường thấy của một Monitoring service để theo dõi các metrics của data và model như là phát hiện Data drift, và theo dõi model performance. Các bạn cũng đã biết cách thiết lập một Alert trên Grafana. Trong thực tế, các bạn có thể sẽ cần dùng Grafana alert để kích hoạt một tác vụ nào đó, ví dụ như kích hoạt training pipeline tự động khi phát hiện dataset bị drift, hay đơn giản là gửi email thông báo về model performance tới Data Scientist, v.v.</p>
<p>Trong bài tiếp theo, chúng ta sẽ thiết lập và triển khai CI/CD cho các phần trong hệ thống ML của chúng ta. CI/CD sẽ giúp chúng ta tự động test, và triển khai các Airflow pipelines, cũng như là các services như là Online serving service, hay Monitoring service, thay vì gõ các lệnh bằng tay trong terminal.</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Metrics hệ thống" class="md-footer__link md-footer__link--prev" href="../metrics-he-thong/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              Metrics hệ thống
            </div>
</div>
</a>
<a aria-label="Next: Giới thiệu" class="md-footer__link md-footer__link--next" href="../../ci-cd/gioi-thieu/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              Giới thiệu
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright 2022 MLOpsVN Community. All Rights Reserved. Licensed under the Creative Commons Attribution 4.0 International Public License
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/mlopsvn/courses.mlops.vn" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate"], "search": "../../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
<script src="../../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "width": "100%", "height": "auto", "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom"});})</script></body>
</html>