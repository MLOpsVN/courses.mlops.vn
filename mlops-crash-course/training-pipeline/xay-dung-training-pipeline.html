
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://courses.mlops.vn/mlops-crash-course/training-pipeline/xay-dung-training-pipeline.html" rel="canonical"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.3.1, mkdocs-material-8.4.1" name="generator"/>
<title>Training pipeline - MLOpsVN Courses</title>
<link href="../../assets/stylesheets/main.69437709.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.cbb835fc.min.css" rel="stylesheet"/>
<meta content="#4cae4f" name="theme-color"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../assets/stylesheets/styles.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-JX2MD05JFT"),document.addEventListener("DOMContentLoaded",function(){if(document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document.forms.feedback){var e,a=document.forms.feedback;for(e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}"undefined"!=typeof location$&&location$.subscribe(function(e){n("config","G-JX2MD05JFT",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-JX2MD05JFT",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
<script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
<link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>html.glightbox-open { overflow: initial; height: 100%; }</style><script src="../../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="green" data-md-color-primary="green" data-md-color-scheme="" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#gioi-thieu">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="MLOpsVN Courses" class="md-header__button md-logo" data-md-component="logo" href="../../index.html" title="MLOpsVN Courses">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            MLOpsVN Courses
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Training pipeline
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="MLOpsVN Courses" class="md-nav__button md-logo" data-md-component="logo" href="../../index.html" title="MLOpsVN Courses">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    MLOpsVN Courses
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../index.html">
        Home
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../index.html">MLOps Crash Course</a>
<label for="__nav_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="MLOps Crash Course" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          MLOps Crash Course
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" id="__nav_2_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_1">
          Tổng quan hệ thống
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Tổng quan hệ thống" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_1">
<span class="md-nav__icon md-icon"></span>
          Tổng quan hệ thống
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../tong-quan-he-thong/tong-quan-mlops.html">
        Tổng quan MLOps
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tong-quan-he-thong/phan-tich-van-de.html">
        Phân tích vấn đề
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tong-quan-he-thong/mlops-platform.html">
        MLOps platform
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../poc/xay-dung-poc.html">
        POC
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" id="__nav_2_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3">
          Data pipeline
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Data pipeline" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
          Data pipeline
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../data-pipeline/tong-quan-data-pipeline.html">
        Tổng quan pipeline
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../data-pipeline/airflow-co-ban.html">
        Airflow cơ bản
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../data-pipeline/feature-store.html">
        Feature store
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../data-pipeline/xay-dung-data-pipeline.html">
        Xây dựng pipeline
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Training pipeline
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="xay-dung-training-pipeline.html">
        Training pipeline
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#gioi-thieu">
    Giới thiệu
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#moi-truong-phat-trien">
    Môi trường phát triển
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cap-nhat-feature-store">
    Cập nhật Feature Store
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-extraction">
    Data extraction
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-validation">
    Data validation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-preparation">
    Data preparation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#model-training">
    Model training
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#model-evaluation">
    Model evaluation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#model-validation">
    Model validation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#airflow-dag">
    Airflow DAG
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tong-ket">
    Tổng kết
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tai-lieu-tham-khao">
    Tài liệu tham khảo
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../model-serving/trien-khai-model-serving.html">
        Model serving
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" id="__nav_2_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_6">
          Monitoring
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Monitoring" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_6">
<span class="md-nav__icon md-icon"></span>
          Monitoring
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../monitoring/tong-quan-monitoring.html">
        Tổng quan monitoring
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../monitoring/metrics-he-thong.html">
        Metrics hệ thống
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../monitoring/thiet-ke-monitoring-service.html">
        Thiết kế monitoring service
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../monitoring/trien-khai-monitoring-service.html">
        Triển khai monitoring service
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7" id="__nav_2_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_7">
          CI/CD
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="CI/CD" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_7">
<span class="md-nav__icon md-icon"></span>
          CI/CD
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../ci-cd/gioi-thieu.html">
        Giới thiệu
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ci-cd/kiem-thu-he-thong.html">
        Kiểm thử hệ thống
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ci-cd/jenkins-co-ban.html">
        Jenkins cơ bản
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ci-cd/data-pipeline.html">
        CI/CD cho data pipeline
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ci-cd/model-serving.html">
        CI/CD cho model serving
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tong-ket/tom-tat-noi-dung.html">
        Tổng kết
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../CONTRIBUTING.html">
        Contributing
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../CODE_OF_CONDUCT.html">
        Code of Conduct
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#gioi-thieu">
    Giới thiệu
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#moi-truong-phat-trien">
    Môi trường phát triển
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cap-nhat-feature-store">
    Cập nhật Feature Store
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-extraction">
    Data extraction
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-validation">
    Data validation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-preparation">
    Data preparation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#model-training">
    Model training
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#model-evaluation">
    Model evaluation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#model-validation">
    Model validation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#airflow-dag">
    Airflow DAG
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tong-ket">
    Tổng kết
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tai-lieu-tham-khao">
    Tài liệu tham khảo
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1>Training pipeline</h1>
<figure>
<a class="glightbox" href="../../assets/images/mlops-crash-course/training-pipeline/xay-dung-training-pipeline/build-pipeline.jpg"><img loading="lazy" src="../../assets/images/mlops-crash-course/training-pipeline/xay-dung-training-pipeline/build-pipeline.jpg"/></a>
<figcaption>Photo by <a href="https://unsplash.com/@selimarda?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">SELİM ARDA ERYILMAZ</a> on <a href="https://unsplash.com/s/photos/pipeline?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></figcaption>
</figure>
<h2 id="gioi-thieu">Giới thiệu</h2>
<p>Sau khi thực hiện ít nhất một dự án POC thành công, chúng ta đã có được:</p>
<ol>
<li>Cách biến đổi data từ data source</li>
<li>Cách biến đổi feature engineering</li>
<li>Code chuẩn bị data để train model</li>
<li>Code train model</li>
<li>Code đánh giá model</li>
</ol>
<p>Phần 1, 2 được dùng trong bài <a href="../data-pipeline/tong-quan-data-pipeline.html">xây dựng data pipeline</a>. Phần 3, 4 và 5 sẽ được dùng trong bài này để xây dựng training pipeline với các task như hình dưới.</p>
<pre class="mermaid"><code>flowchart LR
    n1[1. Cập nhật&lt;br&gt;Feature Store] --&gt; n2[2. Data&lt;br&gt;extraction] --&gt; n3[3. Data&lt;br&gt;validation] --&gt; n4[4. Data&lt;br&gt;preparation] --&gt; n5[5. Model&lt;br&gt;training] --&gt; n6[6. Model&lt;br&gt;evaluation] --&gt; n7[7. Model&lt;br&gt;validation]</code></pre>
<h2 id="moi-truong-phat-trien">Môi trường phát triển</h2>
<p>Các bạn làm các bước sau để cài đặt môi trường phát triển:</p>
<ol>
<li>
<p>Cài đặt <strong>môi trường Python 3.9 mới</strong> với các thư viện cần thiết trong file <code>training_pipeline/dev_requirements.txt</code></p>
</li>
<li>
<p>Đặt environment variable <code>TRAINING_PIPELINE_DIR</code> ở terminal bạn dùng bằng đường dẫn tuyệt đối tới folder <code>training_pipeline</code> và <code>MLFLOW_TRACKING_URI</code> bằng URL của MLflow server. Hai env var này hỗ trợ chạy python code ở folder <code>training_pipeline/src</code> trong quá trình phát triển.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">cd</span> mlops-crash-course-code/training_pipeline
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nb">export</span> <span class="nv">TRAINING_PIPELINE_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nb">export</span> <span class="nv">MLFLOW_TRACKING_URI</span><span class="o">=</span><span class="s2">"http://localhost:5000"</span>
</code></pre></div>
</li>
</ol>
<p>Các MLOps tools được dùng trong bài này bao gồm:</p>
<ol>
<li><strong>Feast:</strong> truy xuất Feature Store</li>
<li><strong>MLflow:</strong> ML Metadata Store, Model Registry</li>
<li><strong>Airflow:</strong> điều phối training pipeline</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Trong quá trình chạy code cho tất cả các phần dưới đây, chúng ta giả sử rằng folder gốc nơi chúng ta làm việc là folder <code>training_pipeline</code>.</p>
</div>
<h2 id="cap-nhat-feature-store">Cập nhật Feature Store</h2>
<p>Trong khoá học này, Feast được dùng làm Feature Store để quản lý phiên bản các features và các bộ features. Feast sử dụng Feature Registry để tập trung lưu trữ định nghĩa về các feature và metadata. Do Feature Registry này được lưu ở dạng file ở máy local, nên mỗi Data Scientist cần tự update Feature Registry trên máy của mình.</p>
<p>Trước khi cập nhật Feature Store, cần đảm bảo code của Feature Store đã được triển khai lên máy của bạn. Trong thực tế, code của Feature Store sẽ được Data Engineer build và release như một library cho phép ML engineer download về và sử dụng.</p>
<p>Code của Feature Store nằm tại <code>data_pipeline/feature_repo</code>. Để triển khai sang training pipeline, chúng ta sẽ copy code từ <code>data_pipeline/feature_repo</code> sang <code>training_pipeline/feature_repo</code>. Bạn hãy chạy các lệnh sau.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nb">cd</span> ../data_pipeline
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>make deploy_feature_repo <span class="c1"># (1)</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nb">cd</span> ../training_pipeline
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="nb">cd</span> feature_repo
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>feast apply <span class="c1"># (2)</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="nb">cd</span> ..
</code></pre></div>
<ol>
<li>Triển khai code của Feature Store</li>
<li>Cập nhật Feature Registry và Offline Feature Store của Feast</li>
</ol>
<h2 id="data-extraction">Data extraction</h2>
<p>Trong task này, các features được lấy từ Offline Feature Store để phục vụ cho quá trình train model.</p>
<ul>
<li><strong>Đầu vào:</strong> tên các features chúng ta muốn lấy</li>
<li><strong>Đầu ra:</strong> file data chứa features được lưu vào disk</li>
</ul>
<p>Code của task này được lưu tại <code>training_pipeline/src/data_extraction.py</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">training_pipeline/src/data_extraction.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">fs</span> <span class="o">=</span> <span class="n">feast</span><span class="o">.</span><span class="n">FeatureStore</span><span class="p">(</span><span class="n">repo_path</span><span class="o">=</span><span class="n">AppPath</span><span class="o">.</span><span class="n">FEATURE_REPO</span><span class="p">)</span> <span class="c1"># (1)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="n">orders</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">AppPath</span><span class="o">.</span><span class="n">DATA</span> <span class="o">/</span> <span class="s2">"driver_orders.csv"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span> <span class="c1"># (2)</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="n">orders</span><span class="p">[</span><span class="s2">"event_timestamp"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">orders</span><span class="p">[</span><span class="s2">"event_timestamp"</span><span class="p">])</span> <span class="c1"># (3)</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="n">training_df</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_historical_features</span><span class="p">(</span> <span class="c1"># (4)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>    <span class="n">entity_df</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>    <span class="n">features</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>        <span class="s2">"driver_stats:conv_rate"</span><span class="p">,</span> <span class="c1"># (5)</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>        <span class="s2">"driver_stats:acc_rate"</span><span class="p">,</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>        <span class="s2">"driver_stats:avg_daily_trips"</span><span class="p">,</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>    <span class="p">],</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span> <span class="c1"># (6)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="n">to_parquet</span><span class="p">(</span><span class="n">training_df</span><span class="p">,</span> <span class="n">AppPath</span><span class="o">.</span><span class="n">TRAINING_PQ</span><span class="p">)</span> <span class="c1"># (7)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Tạo kết nối tới Feature Store</li>
<li>Đọc label từ file <code>driver_orders.csv</code></li>
<li>Định dạng lại format cho cột <code>event_timestamp</code></li>
<li>Download features từ Offline Feature Store.</li>
<li>Các feature chúng ta muốn lấy bao gồm <code>conv_rate</code>, <code>acc_rate</code> và <code>avg_daily_trips</code>. <code>driver_stats</code> là tên <code>FeatureView</code> mà chúng ta đã định nghĩa tại <code>data_pipeline/feature_repo/features.py</code></li>
<li>Cách mà Feast lấy ra features giống như cách chúng ta chuẩn bị data ở dự án POC. Bạn có thể xem lại <a href="../poc/xay-dung-poc.html#chuan-bi-data">tại đây</a>.</li>
<li>Lưu data vào disk để sử dụng trong các task tiếp theo.</li>
</ol>
<p>Bạn làm các bước sau để test thử code.</p>
<ol>
<li>
<p>Chạy code</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nb">cd</span> src
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>python data_extraction.py
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="nb">cd</span> ..
</code></pre></div>
<div class="admonition bug">
<p class="admonition-title">Bug</p>
<p>Nếu các bạn gặp lỗi sau:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>PermissionError: <span class="o">[</span>Errno <span class="m">13</span><span class="o">]</span> Permission denied: <span class="s1">'/training_pipeline'</span>
</code></pre></div>
<p>Thì các bạn cần đặt environment variable <code>TRAINING_PIPELINE_DIR</code> như hướng dẫn ở phần <strong>Môi trường phát triển</strong>.</p>
</div>
</li>
<li>
<p>Kiểm tra folder <code>training_pipeline/artifacts</code>, bạn sẽ thấy file <code>training.parquet</code></p>
</li>
</ol>
<h2 id="data-validation">Data validation</h2>
<figure>
<a class="glightbox" href="../../assets/images/mlops-crash-course/training-pipeline/xay-dung-training-pipeline/validation.jpg"><img loading="lazy" src="../../assets/images/mlops-crash-course/training-pipeline/xay-dung-training-pipeline/validation.jpg"/></a>
<figcaption>Photo by <a href="https://unsplash.com/@amelune?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Diane Serik</a> on <a href="https://unsplash.com/s/photos/test?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></figcaption>
</figure>
<p>Sau khi lấy được data từ Offline Feature Store, chúng ta cần đánh giá data có hợp lệ không trước khi train model, bằng cách kiểm tra.</p>
<ul>
<li>
<p>Cấu trúc data</p>
</li>
<li>
<p>Nhận được feature nào không mong muốn không?</p>
</li>
<li>Nhận đủ feature mong muốn không?</li>
<li>
<p>Feature có ở format mong muốn không?</p>
</li>
<li>
<p>Giá trị của data</p>
</li>
<li>
<p>Các tính chất thống kê của data có như mong muốn không?</p>
</li>
<li>Các giả sử về data có như mong muốn không?</li>
</ul>
<p>Task này không sinh ra các artifact hay file nào, mà nó sẽ quyết định xem task tiếp theo có được thực hiện hay không. Code của task này được lưu tại <code>training_pipeline/src/data_validation.py</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">training_pipeline/src/data_validation.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">def</span> <span class="nf">check_unexpected_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span> <span class="c1"># (1)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>    <span class="n">cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">feature_dict</span><span class="p">:</span> <span class="c1"># (2)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>            <span class="c1"># Báo lỗi feature 'col' không mong muốn</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="k">def</span> <span class="nf">check_expected_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span> <span class="c1"># (3)</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>    <span class="n">dtypes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">feature_dict</span><span class="p">:</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="p">:</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a>            <span class="c1"># Báo lỗi feature 'feature' không tìm thấy</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a>            <span class="n">expected_type</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">feature_dict</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>            <span class="n">real_type</span> <span class="o">=</span> <span class="n">dtypes</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>            <span class="k">if</span> <span class="n">expected_type</span> <span class="o">!=</span> <span class="n">real_type</span><span class="p">:</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>                <span class="c1"># Báo lỗi feature 'feature' có định dạng không mong muốn</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Kiểm tra xem có feature nào không mong muốn</li>
<li><code>config.feature_dict</code> là dictionary với key là tên các feature mong muốn và value là format mong muốn của các feature</li>
<li>Kiểm tra xem có feature mong muốn và ở định dạng mong muốn không</li>
</ol>
<p>Để đơn gian hoá code và tập trung vào MLOps, chúng ta sẽ không kiểm tra các tính chất thống kê của data. Bạn làm các bước sau để test thử code.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nb">cd</span> src
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>python data_validation.py
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="nb">cd</span> ..
</code></pre></div>
<h2 id="data-preparation">Data preparation</h2>
<p>Task Data preparation có đầu vào và đầu ra như sau.</p>
<ul>
<li><strong>Đầu vào:</strong> file data chứa features ở bước Data extraction</li>
<li><strong>Đầu ra:</strong> training set và test set đã được lưu vào disk</li>
</ul>
<p>Task này thực hiện các việc sau.</p>
<ul>
<li>Biến đổi data nếu cần, có thể xảy ra nếu features lấy từ Offline Feature Store không ở định dạng mong muốn</li>
<li>Biến đổi feature engineering nếu cần</li>
<li>Tạo training set, test set để train và đánh giá model</li>
</ul>
<p>Code của task này được lưu tại <code>training_pipeline/src/data_preparation.py</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">training_pipeline/src/data_preparation.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">target_col</span> <span class="o">=</span> <span class="s1">'trip_completed'</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span> <span class="c1"># (1)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>    <span class="n">df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">test_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="p">)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="n">target_col</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">target_col</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="n">train_x</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">target_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="n">train_y</span> <span class="o">=</span> <span class="n">train</span><span class="p">[[</span><span class="n">target_col</span><span class="p">]]</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="n">test_x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">target_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="n">test_y</span> <span class="o">=</span> <span class="n">test</span><span class="p">[[</span><span class="n">target_col</span><span class="p">]]</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="n">to_parquet</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">AppPath</span><span class="o">.</span><span class="n">TRAIN_X_PQ</span><span class="p">)</span> <span class="c1"># (2)</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="n">to_parquet</span><span class="p">(</span><span class="n">train_y</span><span class="p">,</span> <span class="n">AppPath</span><span class="o">.</span><span class="n">TRAIN_Y_PQ</span><span class="p">)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="n">to_parquet</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span> <span class="n">AppPath</span><span class="o">.</span><span class="n">TEST_X_PQ</span><span class="p">)</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="n">to_parquet</span><span class="p">(</span><span class="n">test_y</span><span class="p">,</span> <span class="n">AppPath</span><span class="o">.</span><span class="n">TEST_Y_PQ</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Chia data ra thành training set và test set, vì giả sử chúng ta đã lấy được các feature mong muốn ở định dạng mong muốn, cũng không cần thực hiện thêm các bước biển đổi data, hoặc sinh ra các feature khác nữa</li>
<li>Lưu data vào disk để sử dụng trong các task tiếp theo.</li>
</ol>
<p>Bạn làm các bước sau để test thử code.</p>
<ol>
<li>
<p>Chạy code</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nb">cd</span> src
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>python data_preparation.py
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="nb">cd</span> ..
</code></pre></div>
</li>
<li>
<p>Kiểm tra folder <code>training_pipeline/artifacts</code>, bạn sẽ thấy các files <code>training.parquet</code>, <code>train_x.parquet</code>, <code>test_x.parquet</code>, <code>train_y.parquet</code> và <code>test_y.parquet</code></p>
</li>
</ol>
<h2 id="model-training">Model training</h2>
<p>Task Model training sẽ train model và thực hiện hyperparameter tuning để train model tốt nhất. Tuy nhiên trong bài này, chúng ta sẽ không thực hiện hyperparameter tuning. Task này có:</p>
<ul>
<li><strong>Đầu vào:</strong> data được chuẩn bị ở task Data preparation</li>
<li><strong>Đầu ra:</strong> model đã được train</li>
</ul>
<p>Code cho task Model training đã được viết ở dự án POC. Code của task này được lưu tại <code>training_pipeline/src/model_training.py</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">training_pipeline/src/model_training.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span>
<span class="normal"><a href="#__codelineno-9-21">21</a></span>
<span class="normal"><a href="#__codelineno-9-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">mlflow_tracking_uri</span><span class="p">)</span> <span class="c1"># (1)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="n">train_x</span> <span class="o">=</span> <span class="n">load_df</span><span class="p">(</span><span class="n">AppPath</span><span class="o">.</span><span class="n">TRAIN_X_PQ</span><span class="p">)</span> <span class="c1"># (2)</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="n">train_y</span> <span class="o">=</span> <span class="n">load_df</span><span class="p">(</span><span class="n">AppPath</span><span class="o">.</span><span class="n">TRAIN_Y_PQ</span><span class="p">)</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="n">model</span> <span class="o">=</span> <span class="n">ElasticNet</span><span class="p">(</span> <span class="c1"># (3)</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>    <span class="n">alpha</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>    <span class="n">l1_ratio</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">l1_ratio</span><span class="p">,</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>    <span class="n">random_state</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="p">)</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">"alpha"</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="c1"># (4)</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">"l1_ratio"</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">l1_ratio</span><span class="p">)</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a>    <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a>    <span class="c1"># nơi lưu model</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="p">)</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="n">run_id</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">last_active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span> <span class="c1"># (5)</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="n">run_info</span> <span class="o">=</span> <span class="n">RunInfo</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="n">run_info</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Set URI tới MLflow server</li>
<li>Load data</li>
<li>Train model</li>
<li>Log metadata</li>
<li>Lưu lại thông tin về lần chạy hiện tại để các task tiếp theo biết được model nào vừa được train, để có thể download model và đánh giá model</li>
</ol>
<p>Ở bước Log metadata, chúng ta không cần log lại danh sách các feature được sử dụng nữa, vì bộ feature được dùng đã được version trong code ở bước Data extraction. Nếu có thể, chúng ta nên lưu cả đường dẫn tới data source để đảm bảo có thể theo dõi lại được nguồn gốc của data.</p>
<p>Bạn làm các bước sau để test thử code.</p>
<ol>
<li>
<p>Mở repo <a href="https://github.com/MLOpsVN/mlops-crash-course-platform">mlops-crash-course-platform</a> và chạy mlflow server.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>bash run.sh mlflow up
</code></pre></div>
</li>
<li>
<p>Chạy code</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="nb">cd</span> src
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>python model_training.py
<a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="nb">cd</span> ..
</code></pre></div>
</li>
<li>
<p>Kiểm tra folder <code>training_pipeline/artifacts</code>, bạn sẽ thấy file <code>run_info.json</code></p>
</li>
<li>
<p>Mở MLflow server, bạn sẽ thấy một experiment được tạo ra</p>
<p><a class="glightbox" href="../../assets/images/mlops-crash-course/training-pipeline/xay-dung-training-pipeline/mlflow-training.png"><img loading="lazy" src="../../assets/images/mlops-crash-course/training-pipeline/xay-dung-training-pipeline/mlflow-training.png"/></a></p>
</li>
</ol>
<h2 id="model-evaluation">Model evaluation</h2>
<p>Task Model evaluation thực hiện chạy prediction cho model trên test set. Task này có:</p>
<ul>
<li><strong>Đầu vào:</strong> model đã được train</li>
<li><strong>Đầu ra:</strong> các metrics để đánh giá chất lượng model</li>
</ul>
<p>Code cho task Model evaluation đã được viết ở dự án POC. Code của task này được lưu tại <code>training_pipeline/src/model_evaluation.py</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">training_pipeline/src/model_evaluation.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>    <span class="c1"># nơi lưu model</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="p">)</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="n">test_x</span> <span class="o">=</span> <span class="n">load_df</span><span class="p">(</span><span class="n">AppPath</span><span class="o">.</span><span class="n">TEST_X_PQ</span><span class="p">)</span> <span class="c1"># (1)</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="n">test_y</span> <span class="o">=</span> <span class="n">load_df</span><span class="p">(</span><span class="n">AppPath</span><span class="o">.</span><span class="n">TEST_Y_PQ</span><span class="p">)</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="n">predicted_qualities</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="p">)</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="p">(</span><span class="n">rmse</span><span class="p">,</span> <span class="n">mae</span><span class="p">)</span> <span class="o">=</span> <span class="n">eval_metrics</span><span class="p">(</span><span class="n">test_y</span><span class="p">,</span> <span class="n">predicted_qualities</span><span class="p">)</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="n">eval_result</span> <span class="o">=</span> <span class="n">EvaluationResult</span><span class="p">(</span><span class="n">rmse</span><span class="p">,</span> <span class="n">mae</span><span class="p">)</span> <span class="c1"># (2)</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="n">eval_result</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Chạy inference trên test set</li>
<li>Lưu lại kết quả</li>
</ol>
<p>Kết quả là offline metrics, sẽ được lưu vào disk, để phục vụ cho task Model validation. Bạn làm các bước sau để test thử code.</p>
<ol>
<li>
<p>Chạy code</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="nb">cd</span> src
<a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>python model_evaluation.py
<a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="nb">cd</span> ..
</code></pre></div>
</li>
<li>
<p>Kiểm tra folder <code>training_pipeline/artifacts</code>, bạn sẽ thấy file <code>evaluation.json</code></p>
</li>
</ol>
<h2 id="model-validation">Model validation</h2>
<p>Trong task này, chúng ta dùng các metrics từ task Model evaluation để đánh giá model. Các baseline về metrics nên được định nghĩa ở bước <strong>Phân tích vấn đề</strong>. Việc đánh giá model dựa trên các metrics để chứng tỏ model mới có performance tốt hơn model cũ trước khi triển khai ra production.</p>
<p>Model performance cần được đánh giá trên các phần khác nhau của dataset. Ví dụ như model mới có Accuracy cao hơn model cũ khi đánh giá trên tất cả khách hàng, nhưng có Accuracy trên data của khách hàng ở vài khu vực địa lý thấp hơn model cũ.</p>
<p>Ngoài ra, model có thể cần được kiểm tra xem có tương thích với hệ thống ở production không. Ví dụ:</p>
<ul>
<li>Kiểm tra model mới có nhận vào định dạng đầu vào và trả về định dạng đầu ra tương thích không</li>
<li>Thời gian inference có đảm bảo nằm trong một khoảng yêu cầu của vấn đề kinh doanh không</li>
</ul>
<p>Trong task này, chúng ta chỉ viết code để so sánh offline metrics với các thresholds được định nghĩa trong file <code>training_pipeline/.env</code>. Nếu model thoả mãn các thresholds, chúng ta có thể tự động lưu model vào Model Registry. Thông tin của model được lưu và version của nó cũng được lưu vào disk để sử dụng khi cần, ví dụ để triển khai ra production.</p>
<p>Code của task này được lưu tại <code>training_pipeline/src/model_validation.py</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">training_pipeline/src/model_validation.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="n">eval_result</span> <span class="o">=</span> <span class="n">EvaluationResult</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">AppPath</span><span class="o">.</span><span class="n">EVALUATION_RESULT</span><span class="p">)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="k">if</span> <span class="n">eval_result</span><span class="o">.</span><span class="n">rmse</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">rmse_threshold</span><span class="p">:</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>    <span class="c1"># return vì RMSE không thoả mãn threshold</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="k">if</span> <span class="n">eval_result</span><span class="o">.</span><span class="n">mae</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">mae_threshold</span><span class="p">:</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>    <span class="c1"># return vì MAE không thoả mãn threshold</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="n">result</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span> <span class="c1"># (1)</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a>    <span class="c1"># thông tin về model</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="p">)</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="n">dump_json</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">AppPath</span><span class="o">.</span><span class="n">REGISTERED_MODEL_VERSION</span><span class="p">)</span> <span class="c1"># (2)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Lưu model vào Model Registry nếu các offline metrics thoả mãn threshold</li>
<li>Lưu lại thông tin về model</li>
</ol>
<p>Bạn làm các bước sau để test thử code.</p>
<ol>
<li>
<p>Chạy code</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="nb">cd</span> src
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a>python model_validation.py
<a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="nb">cd</span> ..
</code></pre></div>
</li>
<li>
<p>Nếu model thoả mãn các thresholds, kiểm tra folder <code>training_pipeline/artifacts</code>, bạn sẽ thấy file <code>registered_model_version.json</code></p>
</li>
<li>
<p>Mở MLflow server, bạn sẽ thấy model đã được lưu vào Model Registry</p>
<p><a class="glightbox" href="../../assets/images/mlops-crash-course/training-pipeline/xay-dung-training-pipeline/mlflow-register.png"><img loading="lazy" src="../../assets/images/mlops-crash-course/training-pipeline/xay-dung-training-pipeline/mlflow-register.png"/></a></p>
</li>
<li>
<p>Click vào model để xem thêm thông tin model. Như hình dưới, MLflow đã ghi lại cả định dạng hợp lệ cho input và output của model</p>
<p><a class="glightbox" href="../../assets/images/mlops-crash-course/training-pipeline/xay-dung-training-pipeline/mlflow-model-version.png"><img loading="lazy" src="../../assets/images/mlops-crash-course/training-pipeline/xay-dung-training-pipeline/mlflow-model-version.png"/></a></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Phần Schema định nghĩa định dạng đầu vào và đầu ra của model. Định dạng này được gọi là <strong>Model Signature</strong></p>
</div>
</li>
</ol>
<h2 id="airflow-dag">Airflow DAG</h2>
<p>Ở phần này, Airflow DAG được dùng để kết nối các task trên lại thành một DAG hay một pipeline hoàn chỉnh. Code định nghĩa Airflow DAG được lưu tại <code>training_pipeline/dags/training_dag.py</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">training_pipeline/dags/training_dag.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>    <span class="n">dag_id</span><span class="o">=</span><span class="s2">"training_pipeline"</span><span class="p">,</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a>    <span class="n">schedule_interval</span><span class="o">=</span><span class="s2">"@once"</span><span class="p">,</span> <span class="c1"># (1)</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a>    <span class="c1"># các argument khác</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a>    <span class="n">feature_store_init_task</span> <span class="o">=</span> <span class="n">DockerOperator</span><span class="p">(</span> <span class="c1"># (2)</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a>        <span class="n">task_id</span><span class="o">=</span><span class="s2">"feature_store_init_task"</span><span class="p">,</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a>        <span class="n">command</span><span class="o">=</span><span class="s2">"bash -c 'cd feature_repo &amp;&amp; feast apply'"</span><span class="p">,</span> <span class="c1"># (3)</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a>        <span class="o">**</span><span class="n">DefaultConfig</span><span class="o">.</span><span class="n">DEFAULT_DOCKER_OPERATOR_ARGS</span><span class="p">,</span> <span class="c1"># (4)</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a>    <span class="p">)</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a>    <span class="n">data_extraction_task</span> <span class="o">=</span> <span class="n">DockerOperator</span><span class="p">(</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a>        <span class="n">task_id</span><span class="o">=</span><span class="s2">"data_extraction_task"</span><span class="p">,</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a>        <span class="n">command</span><span class="o">=</span><span class="s2">"bash -c 'cd src &amp;&amp; python data_extraction.py'"</span><span class="p">,</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a>        <span class="o">**</span><span class="n">DefaultConfig</span><span class="o">.</span><span class="n">DEFAULT_DOCKER_OPERATOR_ARGS</span><span class="p">,</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a>    <span class="p">)</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a>    <span class="c1"># các task khác</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>DAG sẽ chạy một lần khi được bật, sau đó sẽ cần kích hoạt lại bằng tay</li>
<li>Vì các task khác nhau có môi trường chạy và các dependencies khác nhau, nên <code>DockerOperator</code> được dùng để cách ly các task trong các docker containers khác nhau. Để đơn giản, chúng ta chỉ dùng một Docker image duy nhất cho tất cả các task</li>
<li>Command sẽ được gọi trong mỗi task. Command này giống với command bạn đã chạy trong quá trình viết code ở trên</li>
<li>Vì chỉ một docker image duy nhất dùng cho các tasks, nên chỉ cần một config chung cho các docker containers được tạo ra ở mỗi task. Config chung này được lưu trong biến <code>DefaultConfig.DEFAULT_DOCKER_OPERATOR_ARGS</code>.</li>
</ol>
<p>Tiếp theo, chúng ta cần build docker image <code>mlopsvn/mlops_crash_course/training_pipeline:latest</code> và triển khai Airflow DAG bằng các bước sau.</p>
<ol>
<li>
<p>Đăng nhập vào Airflow UI với tài khoản và mật khẩu là <code>airflow</code>.</p>
</li>
<li>
<p>Đặt Airflow Variable <code>MLOPS_CRASH_COURSE_CODE_DIR</code> bằng đường dẫn tuyệt đối tới folder <code>mlops-crash-course-code/</code>. Tham khảo <a href="https://airflow.apache.org/docs/apache-airflow/stable/howto/variable.html">hướng dẫn này</a> để đặt Airflow Variable.</p>
</li>
<li>
<p>Chạy lệnh</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a>make build_image
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a>make deploy_dags <span class="c1"># (1)</span>
</code></pre></div>
<ol>
<li>Copy <code>training_pipeline/dags/*</code> vào folder <code>dags</code> của Airflow</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Định nghĩa về các env vars được dùng trong quá trình chạy Airflow DAG được lưu tại <code>training_pipeline/.env</code>. Bạn có thể thay đổi nếu cần.</p>
</div>
</li>
<li>
<p>Kích hoạt training pipeline và đợi kết quả</p>
<p><a class="glightbox" href="../../assets/images/mlops-crash-course/training-pipeline/xay-dung-training-pipeline/training-pipeline-airflow.png"><img loading="lazy" src="../../assets/images/mlops-crash-course/training-pipeline/xay-dung-training-pipeline/training-pipeline-airflow.png"/></a></p>
</li>
<li>
<p>Sau khi Airflow DAG hoàn thành, kiểm tra MLflow server, bạn sẽ thấy metadata của lần chạy experiment mới và model train xong đã được log lại</p>
</li>
</ol>
<h2 id="tong-ket">Tổng kết</h2>
<p>Chúng ta vừa trải qua quy trình phát triển điển hình cho training pipeline. Tuỳ thuộc vào mức độ phức tạp của dự án và các chức năng của dự án mà có thể bỏ bớt hoặc thêm vào các task khác. Các task cũng có thể được chia nhỏ ra để thực hiện các công việc đòi hỏi tính toán nặng, tránh việc phải chạy lại nhiều lần.</p>
<p>Trong một dự án ML, trong khi Data Scientist vẫn thực hiện các thử nghiệm trên data và model, ML engineer/MLOps engineer có thể xây dựng training pipeline được cập nhật liên tục dựa trên yêu cầu từ Data Scientist.</p>
<p>Sau khi tự động hoá training pipeline, trong bài tiếp theo chúng ta sẽ xây dựng và tự động hoá quá trình triển khai model.</p>
<h2 id="tai-lieu-tham-khao">Tài liệu tham khảo</h2>
<ul>
<li><a href="https://docs.google.com/document/d/1UqrR4QP_RMZErC7uLMoLvPtzLys6ikgeUXiylS1WWPE/edit#heading=h.ozmqmwituoup">CS 329S. Lecture 5. Model Development</a></li>
<li><a href="https://cloud.google.com/architecture/mlops-continuous-delivery-and-automation-pipelines-in-machine-learning">MLOps: Continuous delivery and automation pipelines in machine learning</a></li>
</ul>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Xây dựng pipeline" class="md-footer__link md-footer__link--prev" href="../data-pipeline/xay-dung-data-pipeline.html" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              Xây dựng pipeline
            </div>
</div>
</a>
<a aria-label="Next: Model serving" class="md-footer__link md-footer__link--next" href="../model-serving/trien-khai-model-serving.html" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              Model serving
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright 2022 MLOpsVN Community. All Rights Reserved. Licensed under the Creative Commons Attribution 4.0 International Public License
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/mlopsvn/courses.mlops.vn" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate"], "search": "../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "width": "100%", "height": "auto", "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom"});})</script></body>
</html>